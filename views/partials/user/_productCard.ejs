<div class="swiper-slide h-auto">
  <a href="/products/<%= product?.variants?._id %>" class="block group h-full">
    <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden h-full relative border border-gray-100">

      <% 
        // PRICING
        const regularPrice = product?.variants?.regularPrice || 0;
        const salePrice = product?.variants?.salePrice || 0;
        const offerAmount = product?.offer || 0;
        const currentPrice = salePrice - offerAmount;

        let discountPercent = 0;
        if (regularPrice > currentPrice) {
          discountPercent = Math.round(((regularPrice - currentPrice) / regularPrice) * 100);
        }

        // CART STATUS
        const isInCart = product?.cart ? true : false;
      %>

      <!-- IMAGE + WISHLIST -->
      <div class="relative bg-gray-100 p-5 flex items-center justify-center h-56">

        <img src="<%= product?.variants?.images[0] %>" alt="<%= product.name %>" class="h-full w-auto object-contain transition-all duration-300 group-hover:scale-105" />

        <% if (!isInCart) { %>
        <button 
          class="wishlist-btn absolute top-4 right-4 w-10 h-10 rounded-full 
          flex items-center justify-center shadow-md transition-all z-20 
          <%= product.variants.isInWishlist ? 'text-red-500' : 'text-gray-500' %>"
          data-variant-id="<%= product.variants._id %>"
          onclick="event.preventDefault(); toggleWishlist('<%= product.variants._id %>', event)"
        >
          <% if (product.variants.isInWishlist) { %>
            <i class="bi bi-heart-fill wishlist-icon text-red-500"></i>
          <% } else { %>
            <i class="bi bi-heart wishlist-icon"></i>
          <% } %>
        </button>
        <% } %>

        <% if (discountPercent > 0) { %>
        <div class="absolute top-4 left-4 bg-red-500 text-white px-2 py-1 rounded-md text-xs font-bold shadow">
          <%= discountPercent %>% OFF
        </div>
        <% } %>

      </div>

      <!-- PRODUCT INFO -->
      <div class="px-5 pt-4 pb-20 relative">

        <h3 class="text-lg font-semibold text-gray-900 leading-tight line-clamp-2 min-h-[48px]">
          <%= product.name %>
        </h3>

        <div class="flex gap-2 flex-wrap mt-2">
          <% if (product?.variants?.colour) { %>
          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">
            <i class="bi bi-palette"></i> <%= product.variants.colour %>
          </span>
          <% } %>
          <% if (product?.variants?.ram) { %>
          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">
            <i class="bi bi-memory"></i> <%= product.variants.ram %>
          </span>
          <% } %>
          <% if (product?.variants?.storage) { %>
          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">
            <i class="bi bi-device-hdd"></i> <%= product.variants.storage %>
          </span>
          <% } %>
        </div>

        <!-- RATING -->
        <div class="flex items-center mt-2">
          <% 
            const rating = product?.variants?.rating || 0;
            const full = Math.floor(rating);
            const half = (rating % 1) >= 0.5;
            const empty = 5 - full - (half ? 1 : 0);
          %>

          <% for (let i = 0; i < full; i++) { %><i class="bi bi-star-fill text-yellow-400 text-sm"></i><% } %>
          <% if (half) { %><i class="bi bi-star-half text-yellow-400 text-sm"></i><% } %>
          <% for (let i = 0; i < empty; i++) { %><i class="bi bi-star text-yellow-400 text-sm"></i><% } %>

          <span class="text-sm text-gray-500 ml-1">(<%= rating.toFixed(1) %>)</span>
        </div>

        <!-- PRICE -->
        <div class="mt-3">
          <p class="text-2xl font-bold text-gray-900 flex items-center gap-2">
            â‚¹<%= currentPrice.toLocaleString('en-IN') %>

            <% if (regularPrice > currentPrice) { %>
            <del class="text-gray-400 text-base">
              â‚¹<%= regularPrice.toLocaleString('en-IN') %>
            </del>
            <% } %>
          </p>

          <% if (offerAmount > 0) { %>
          <p class="text-green-600 text-xs font-semibold mt-1">
            Save â‚¹<%= (regularPrice-currentPrice).toLocaleString('en-IN') %> with offers
          </p>
          <% } %>
        </div>

        <!-- STOCK -->
        <% if (product?.variants?.stock > 0 && product?.variants?.stock < 10) { %>
        <p class="text-xs text-orange-600 font-semibold mt-2">
          <i class="bi bi-exclamation-triangle"></i>
          Only <%= product.variants.stock %> left!
        </p>
        <% } else if (product?.variants?.stock <= 0) { %>
        <p class="text-xs text-red-600 font-semibold mt-2">
          <i class="bi bi-x-circle"></i>
          Out of Stock
        </p>
        <% } %>

      </div>

      <!-- CART BUTTONS (STATIC) -->
      <% if (product?.variants?.stock > 0) { %>

      <% if (isInCart) { %>
      <!-- STATIC GO TO CART BUTTON -->
      <button type="button" class="absolute left-0 bottom-0 w-full bg-white text-blue-600 border border-blue-600 
                   font-semibold py-3 rounded-b-2xl text-center" onclick="event.preventDefault(); window.location.href='/cart'">
        <i class="bi bi-arrow-right-circle"></i> Go to Cart
      </button>

      <% } else { %>

      <!-- STATIC ADD TO CART BUTTON -->
      <button type="button" data-cart-variant-id="<%= product?.variants?._id %>" class="absolute left-0 bottom-0 w-full bg-blue-600 text-white font-semibold py-3 rounded-b-2xl text-center" onclick="event.preventDefault(); addToCart('<%= product?.variants?._id %>')">
        <i class="bi bi-cart-plus"></i> Add to Cart
      </button>

      <% } %>

      <% } else { %>

      <button type="button" class="absolute left-0 bottom-0 w-full bg-gray-300 text-gray-600 font-semibold py-3 rounded-b-2xl cursor-not-allowed" disabled>
        <i class="bi bi-x-circle"></i> Out of Stock
      </button>

      <% } %>

    </div>
  </a>
</div>

<script>
  // ----------------------------
  // â¤ï¸ TOGGLE WISHLIST
  // ----------------------------
  async function toggleWishlist(variantId, event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    try {
      const response = await axios.post('/wishlist/toggle', {
        variantId
      });

      if (response.data.success) {
        const isAdded = response.data.action === 'added';

        Toastify({
          text: response.data.message,
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: isAdded ? "#10b981" : "#ef4444",
          close: true,
        }).showToast();

        updateWishlistButton(variantId, isAdded);
        updateWishlistBadge(response.data.itemCount);
      }

    } catch (error) {
      console.error('Wishlist error:', error);

      if (error.response?.status === 401) {
        Toastify({
          text: "Please login to add items to wishlist",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: "#ef4444",
        }).showToast();

        setTimeout(() => window.location.href = '/login', 1200);
      }
    }
  }

  // ----------------------------
  // â¤ï¸ UPDATE WISHLIST ICON UI
  // ----------------------------
  function updateWishlistButton(variantId, inWishlist) {
    const buttons = document.querySelectorAll(`[data-variant-id="${variantId}"]`);

    buttons.forEach(btn => {
      const icon = btn.querySelector('.wishlist-icon');
      if (!icon) return;

      if (inWishlist) {
        icon.classList.remove('bi-heart');
        icon.classList.add('bi-heart-fill', 'text-red-500');
        btn.classList.add('text-red-500');
      } else {
        icon.classList.remove('bi-heart-fill', 'text-red-500');
        icon.classList.add('bi-heart');
        btn.classList.remove('text-red-500');
      }
    });
  }

  // ----------------------------
  // â¤ï¸ NAVBAR BADGE UPDATE
  // ----------------------------
  function updateWishlistBadge(count) {
    const badge = document.querySelector('a[href="/wishlist"] span');
    if (!badge) return;

    badge.textContent = count;

    if (count > 0) badge.classList.remove('hidden');
    else badge.classList.add('hidden');
  }

  

  // ----------------------------
  // ðŸ›’ ADD TO CART
  // ----------------------------
  async function addToCart(variantId) {
    try {
      const response = await axios.post("/cart/add", {
        variantId,
        quantity: 1
      });

      if (response.data.success) {

        updateCartButton(variantId);
        removeWishlistButton(variantId);

        Toastify({
          text: "Item added to cart",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          style: {
            background: "linear-gradient(to right, #00b09b, #96c93d)"
          },
          close: true
        }).showToast();
      }

    } catch (error) {
      if(error?.response?.data?.redirect){
        sessionStorage.setItem("toastSuccess", error.responce.data.message);
        window.location.href = error.responce.data.redirect;
      }
      Toastify({
        text: error.response?.data?.message || "Something went wrong",
        duration: 2000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#e74c3c"
      }).showToast();
    }
  }

  // ----------------------------
  // ðŸ—‘ REMOVE WISHLIST BUTTON ON ADD TO CART
  // ----------------------------
  function removeWishlistButton(variantId) {
    const buttons = document.querySelectorAll(`[data-variant-id="${variantId}"]`);
    buttons.forEach(btn => btn.remove());
  }

  // ----------------------------
  // ðŸ”„ UPDATE CART BUTTON (Add â†’ Go to Cart)
  // ----------------------------
  function updateCartButton(variantId) {
    console.log(variantId)
    const btn = document.querySelectorAll(`[data-cart-variant-id="${variantId}"]`);
    if (btn.length === 0) return;
    btn.forEach(b => {
      b.outerHTML = `
      <button 
        type="button"
        class="absolute left-0 bottom-0 w-full bg-white text-blue-600 border border-blue-600 
               font-semibold py-3 rounded-b-2xl text-center"
        onclick="event.preventDefault(); window.location.href='/cart'"
      >
        <i class="bi bi-arrow-right-circle"></i> Go to Cart
      </button>
    `;
    })
  }
</script>