<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <div class="flex gap-6">
      <!-- Sidebar -->
      <%- include('../partials/user/profile/sidebar', { pageTitle: 'My Wishlist', user: user }) %>

      <!-- Main Content -->
      <div class="flex-1">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h1 class="text-2xl font-semibold text-gray-900">My Wishlist</h1>
              <p class="text-gray-600 mt-1">
                <span id="wishlist-count"><%= wishlist?.items?.length || 0 %></span> items in your wishlist
              </p>
            </div>
            <% if (wishlist && wishlist.items && wishlist.items.length > 0) { %>
            <button onclick="clearWishlist()" class="px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition-colors font-medium text-sm">
              <i class="bi bi-trash"></i> Clear All
            </button>
            <% } %>
          </div>

          <!-- Wishlist Items -->
          <div id="wishlistItems">
            <% if (wishlist && wishlist.items && wishlist.items.length > 0) { %>
            <div class="space-y-4">
              <% wishlist.items.forEach(function(item) { 
                const outOfStock = item.variantId.stock <= 0;
                const regularPrice = item.variantId.regularPrice || 0;
                const salePrice = item.variantId.salePrice || 0;
                const offerAmount = item.offer || 0; // same as product grid
                const currentPrice = salePrice - offerAmount;

                let discountPercent = 0;
                if (regularPrice > currentPrice) {
                  discountPercent = Math.round(((regularPrice - currentPrice) / regularPrice) * 100);
                }
              %>
              <div class="wishlist-item border border-gray-200 rounded-xl p-4 hover:border-blue-300 hover:shadow-md transition-all <%= outOfStock ? 'opacity-75' : '' %>">
                <div class="flex gap-4">
                  <!-- Product Image -->
                  <div class="relative w-32 h-32 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                    <a href="/products/<%= item.variantId._id %>">
                      <img src="<%= item.variantId.images[0] %>" alt="<%= item.productId.name %>" class="w-full h-full object-contain hover:scale-105 transition-transform" />
                    </a>

                    <!-- Out of Stock Badge -->
                    <% if (outOfStock) { %>
                    <div class="absolute top-2 left-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-semibold">
                      Out of Stock
                    </div>
                    <% } else if (item.variantId.stock <= 5) { %>
                    <div class="absolute top-2 left-2 bg-orange-600 text-white px-2 py-1 rounded text-xs font-semibold">
                      Only <%= item.variantId.stock %> left
                    </div>
                    <% } %>
                  </div>

                  <!-- Product Details -->
                  <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start gap-4">
                      <div class="flex-1">
                        <a href="/products/<%= item.variantId._id %>" class="block">
                          <h3 class="font-semibold text-lg text-gray-900 mb-2 line-clamp-2 hover:text-blue-600 transition-colors">
                            <%= item.productId.name %>
                          </h3>
                        </a>

                        <!-- Variant Details -->
                        <div class="flex flex-wrap gap-2 mb-3">
                          <% if (item.variantId.colour) { %>
                          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                            <i class="bi bi-palette"></i> <%= item.variantId.colour %>
                          </span>
                          <% } %>
                          <% if (item.variantId.ram) { %>
                          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                            <i class="bi bi-memory"></i> <%= item.variantId.ram %>
                          </span>
                          <% } %>
                          <% if (item.variantId.storage) { %>
                          <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                            <i class="bi bi-device-hdd"></i> <%= item.variantId.storage %>
                          </span>
                          <% } %>
                        </div>

                        <!-- Price -->
                        <div class="flex items-center gap-3 mb-2">
                          <span class="text-2xl font-bold text-gray-900">
                            ₹<%= currentPrice.toLocaleString('en-IN') %>
                          </span>
                          <% if (regularPrice > currentPrice) { %>
                            <span class="text-sm text-gray-500 line-through">
                              ₹<%= regularPrice.toLocaleString('en-IN') %>
                            </span>

                            <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded">
                              <%= discountPercent %>% OFF
                            </span>
                          <% } %>
                        </div>

                        <!-- Added Date -->
                        <p class="text-xs text-gray-500">
                          <i class="bi bi-calendar"></i> Added <%= new Date(item.addedAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                        </p>
                      </div>

                      <!-- Remove Button -->
                      <button onclick="removeFromWishlist('<%= item.variantId._id %>')" class="text-gray-400 hover:text-red-500 transition-colors p-2" title="Remove from wishlist">
                        <i class="bi bi-x-circle-fill text-2xl"></i>
                      </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 mt-4">
                      <% if (!outOfStock) { %>
                      <button onclick="moveToCart('<%= item._id %>', '<%= item.variantId._id %>')" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                      </button>
                      <% } else { %>
                      <button disabled class="px-6 py-2.5 bg-gray-300 text-gray-500 font-semibold rounded-lg cursor-not-allowed text-sm">
                        <i class="bi bi-x-circle"></i> Out of Stock
                      </button>
                      <% } %>
                      <a href="/products/<%= item.variantId._id %>" class="px-6 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <i class="bi bi-eye"></i> View Details
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
            <% } else { %>
            <!-- Empty Wishlist -->
            <div class="text-center py-16">
              <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-heart text-5xl text-gray-400"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Your Wishlist is Empty</h3>
              <p class="text-gray-600 mb-6">Save your favorite items to your wishlist</p>
              <a href="/shop" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                <i class="bi bi-shop"></i> Start Shopping
              </a>
            </div>
            <% } %>
          </div>

          <!-- Pagination (if needed) -->
          <% if (wishlist && wishlist.items && wishlist.items.length > 0 && totalPages > 1) { %>
          <div class="mt-10 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <!-- Left: Showing X to Y -->
            <div class="text-sm text-gray-600">
              <% 
                const startItem = (currentPage - 1) * limit + 1;
                const endItem = (currentPage - 1) * limit + wishlist.items.length;
              %>
              Showing <span class="font-medium text-gray-900"><%= startItem %></span>
              to
              <span class="font-medium text-gray-900"><%= endItem %></span>
              of
              <span class="font-medium text-gray-900"><%= totalDocuments %></span> items
            </div>

            <!-- Right: Pagination Controls -->
            <div class="flex items-center gap-2">
              <!-- Previous Arrow -->
              <% if (currentPage > 1) { %>
              <button onclick="changeWishlistPage(<%= currentPage - 1 %>)" class="w-9 h-9 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                <i class="bi bi-chevron-left text-gray-700"></i>
              </button>
              <% } else { %>
              <button disabled class="w-9 h-9 flex items-center justify-center rounded-lg border border-gray-200 bg-gray-100 cursor-not-allowed">
                <i class="bi bi-chevron-left text-gray-400"></i>
              </button>
              <% } %>

              <!-- Page Numbers -->
              <% for (let i = 1; i <= totalPages; i++) { %>
              <button onclick="changeWishlistPage(<%= i %>)" class="min-w-[36px] h-9 px-3 flex items-center justify-center rounded-lg border text-sm font-medium transition
                    <%= currentPage === i 
                          ? 'bg-blue-600 text-white border-blue-600' 
                          : 'border-gray-300 text-gray-700 hover:bg-gray-100' %>">
                <%= i %>
              </button>
              <% } %>

              <!-- Next Arrow -->
              <% if (currentPage < totalPages) { %>
              <button onclick="changeWishlistPage(<%= currentPage + 1 %>)" class="w-9 h-9 flex items-center justify-center rounded-lg border border-gray-300 hover:bg-gray-100 transition">
                <i class="bi bi-chevron-right text-gray-700"></i>
              </button>
              <% } else { %>
              <button disabled class="w-9 h-9 flex items-center justify-center rounded-lg border border-gray-200 bg-gray-100 cursor-not-allowed">
                <i class="bi bi-chevron-right text-gray-400"></i>
              </button>
              <% } %>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Remove from wishlist
  async function removeFromWishlist(variantId) {
    try {
      const response = await axios.post(`/wishlist/toggle`, {
        variantId
      });

      if (response.data.success) {
        Toastify({
          text: "Item removed from wishlist",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: "#ef4444",
        }).showToast();

        // Reload page to update wishlist
        window.location.reload();
      }
    } catch (error) {
      console.error('Error removing from wishlist:', error);
      Toastify({
        text: error.response?.data?.message || "Failed to remove item",
        duration: 3000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#ef4444",
      }).showToast();
    }
  }

  // Clear entire wishlist
  async function clearWishlist() {
    const confirmed = confirm("Are you sure you want to clear your entire wishlist?");
    if (!confirmed) return;

    try {
      const response = await axios.delete('/wishlist/clear');

      if (response.data.success) {
        Toastify({
          text: "Wishlist cleared successfully",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: "#10b981",
        }).showToast();

        window.location.reload();
      }
    } catch (error) {
      console.error('Error clearing wishlist:', error);
      Toastify({
        text: error.response?.data?.message || "Failed to clear wishlist",
        duration: 3000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#ef4444",
      }).showToast();
    }
  }

  // Move item to cart
  async function moveToCart(itemId, variantId) {
    try {
      const response = await axios.post("/cart/add", {
        variantId,
        quantity: 1
      });
      Toastify({
        text: "Item moved to cart",
        duration: 1000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#10b981",
      }).showToast();
      setTimeout(() => {
        window.location.reload();
      }, 1200);
    } catch (error) {
      console.log(error);
      Toastify({
        text: error.response?.data?.message || "Something went wrong",
        duration: 2000,
        gravity: "bottom",
        position: "right",
        style: {
          background: "#e74c3c",
        },
      }).showToast();
    }
  }

  // Pagination
  function changeWishlistPage(page) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    window.location.href = url.toString();
  }
</script>