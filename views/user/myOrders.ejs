<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <div class="flex gap-6">
      <!-- Sidebar -->
      <%- include('../partials/user/profile/sidebar', { pageTitle: 'My Orders', user: user }) %>

      <!-- Main Content -->
      <div class="flex-1">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 mb-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h1 class="text-2xl font-semibold text-gray-900">My Orders</h1>
              <p class="text-gray-600 mt-1">Track and manage your orders</p>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="filterOrders('all')" class="filter-tab active px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              All Orders
            </button>
            <button onclick="filterOrders('Pending')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Pending
            </button>
            <button onclick="filterOrders('Processing')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Processing
            </button>
            <button onclick="filterOrders('Shipped')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Shipped
            </button>
            <button onclick="filterOrders('Delivered')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Delivered
            </button>
            <button onclick="filterOrders('Cancelled')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Cancelled
            </button>
            <button onclick="filterOrders('Returned')" class="filter-tab px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-colors">
              Returned
            </button>
          </div>

          <!-- Add this after the Filter Tabs section, before the Orders List -->
          <div class="mb-6">
            <div class="relative">
              <input type="text" id="orderSearch" placeholder="Search by Order ID, Product Name, or Status..." class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" onkeyup="searchOrders()">
              <i class="bi bi-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i>
            </div>
          </div>

          <!-- Orders List -->
          <div id="ordersList" class="space-y-6">
            <% if (orders && orders.length > 0) { %>
            <% orders.forEach(function(order) { %>
            <div class="order-item border border-gray-200 rounded-xl p-6 hover:border-blue-300 transition-colors" data-status="<%= order.orderStatus %>">
              <!-- Order Header -->
              <div class="flex flex-wrap justify-between items-start gap-4 mb-4 pb-4 border-b border-gray-200">
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-lg font-bold text-gray-900">Order #<%= order.orderId %></h3>
                    <span class="status-badge px-3 py-1 rounded-full text-xs font-semibold <%= getStatusClass(order.orderStatus) %>">
                      <%= order.orderStatus %>
                    </span>
                  </div>
                  <p class="text-sm text-gray-600">
                    <i class="bi bi-calendar"></i> Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                  </p>
                  <% if (order.expectedDelivery) { %>
                  <p class="text-sm text-gray-600">
                    <i class="bi bi-truck"></i> Expected by <%= new Date(order.expectedDelivery).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                  </p>
                  <% } %>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-600 mb-1">Total Amount</p>
                  <p class="text-2xl font-bold text-gray-900">₹<%= order.finalAmount.toLocaleString('en-IN') %></p>
                </div>
              </div>

              <!-- Order Items -->
              <div class="space-y-3 mb-4">
                <% order.orderedItems.forEach(function(item, index) { %>
                <div class="flex gap-4 <%= ['Cancelled', 'Returned'].includes(item.itemStatus) ? 'opacity-60' : '' %>">
                  <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                    <img src="<%= item.variantId.images[0] %>" alt="<%= item.productId.name %>" class="w-full h-full object-contain">
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start gap-2">
                      <h4 class="font-semibold text-gray-900 line-clamp-1 flex-1"><%= item.productId.name %></h4>
                      <!-- Item Status Badge -->
                      <span class="px-2 py-0.5 rounded text-xs font-semibold whitespace-nowrap <%= getItemStatusClass(item.itemStatus) %>">
                        <%= item.itemStatus.replace(/([A-Z])/g, ' $1').trim() %>
                      </span>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mt-1">
                      <% if (item.variantId.colour) { %>
                      <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">
                        <%= item.variantId.colour %>
                      </span>
                      <% } %>
                      <% if (item.variantId.ram) { %>
                      <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">
                        <%= item.variantId.ram %>
                      </span>
                      <% } %>
                      <% if (item.variantId.storage) { %>
                      <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">
                        <%= item.variantId.storage %>
                      </span>
                      <% } %>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                      <span class="text-sm text-gray-600">Qty: <%= item.quantity %></span>
                      <span class="font-bold text-gray-900">₹<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
                    </div>
                    <!-- Item Cancel/Return Reason -->
                    <% if (item.reason && ['Cancelled', 'ReturnRequested', 'Returned'].includes(item.itemStatus)) { %>
                    <p class="text-xs text-gray-600 mt-1 italic">
                      <i class="bi bi-info-circle"></i> Reason: <%= item.reason %>
                    </p>
                    <% } %>
                    <!-- Admin Note (Return Approved or Rejected) -->
                    <% if (item.adminNote && ['ReturnApproved', 'ReturnRejected', 'Returned'].includes(item.itemStatus)) { %>
                    <p class="text-xs text-blue-700 mt-1 italic">
                      <i class="bi bi-chat-left-quote"></i> Admin Note: <%= item.adminNote %>
                    </p>
                    <% } %>

                  </div>
                </div>
                <% }); %>
              </div>

              <!-- Payment & Delivery Info -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <p class="text-xs text-gray-600 mb-1">Payment Method</p>
                  <div class="flex items-center gap-2">
                    <% if (order.paymentMethod === 'razorpay') { %>
                    <i class="bi bi-credit-card text-blue-600"></i>
                    <span class="font-medium text-gray-900">Online Payment</span>
                    <% } else if (order.paymentMethod === 'wallet') { %>
                    <i class="bi bi-wallet2 text-purple-600"></i>
                    <span class="font-medium text-gray-900">Wallet</span>
                    <% } else if (order.paymentMethod === 'cod') { %>
                    <i class="bi bi-cash-coin text-orange-600"></i>
                    <span class="font-medium text-gray-900">Cash on Delivery</span>
                    <% } %>
                    <span class="ml-auto px-2 py-0.5 rounded text-xs font-semibold <%= order.paymentStatus === 'Paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                      <%= order.paymentStatus %>
                    </span>
                  </div>
                </div>
                <div>
                  <p class="text-xs text-gray-600 mb-1">Delivery Address</p>
                  <p class="font-medium text-gray-900 text-sm line-clamp-2">
                    <%= order.shippingAddress.fullName %>, <%= order.shippingAddress.city %>
                  </p>
                </div>
              </div>

              <!-- Order Actions -->
              <div class="flex flex-wrap gap-3">
                <a href="/order/details/<%= order._id %>" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors text-sm">
                  <i class="bi bi-eye"></i> View Details
                </a>

                <% if (order.orderStatus === 'Delivered' || order.orderStatus === 'Partially Delivered') { %>
                <button onclick="downloadInvoice('<%= order.orderId %>')" class="px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors text-sm">
                  <i class="bi bi-download"></i> Download Invoice
                </button>
                <% } %>

                <% 
                      const hasCancellableItems = order.orderedItems.some(item => 
                        ['Pending', 'Confirmed', 'Processing'].includes(item.itemStatus)
                      );
                      const hasReturnableItems = order.orderedItems.some(item => 
                        item.itemStatus === 'Delivered'
                      );
                    %>

                <% if (hasCancellableItems) { %>
                <button onclick='openCancelOrderModal(<%= JSON.stringify(order) %>)' class="px-4 py-2 bg-red-50 text-red-600 font-semibold rounded-lg hover:bg-red-100 transition-colors text-sm">
                  <i class="bi bi-x-circle"></i> Cancel Items
                </button>
                <% } %>

                <% if (hasReturnableItems) { %>
                <button onclick='openReturnOrderModal(<%= JSON.stringify(order) %>)' class="px-4 py-2 bg-orange-50 text-orange-600 font-semibold rounded-lg hover:bg-orange-100 transition-colors text-sm">
                  <i class="bi bi-arrow-return-left"></i> Return Items
                </button>
                <% } %>

                <% 
                  const hasTrackableItem = order.orderedItems.some(item => 
                    ["Shipped", "Out for Delivery"].includes(item.itemStatus)
                  );
                %>

                <% if (hasTrackableItem) { %>
                <button onclick="trackOrder('<%= order._id %>')" class="px-4 py-2 bg-green-50 text-green-600 font-semibold rounded-lg hover:bg-green-100 transition-colors text-sm">
                  <i class="bi bi-geo-alt"></i> Track Order
                </button>
                <% } %>
              </div>
            </div>
            <% }); %>
            <% } else { %>
            <!-- Empty State -->
            <div class="text-center py-16">
              <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-box-seam text-5xl text-gray-400"></i>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">No Orders Found</h3>
              <p class="text-gray-600 mb-6">You haven't placed any orders yet</p>
              <a href="/shop" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                <i class="bi bi-shop"></i> Start Shopping
              </a>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Single Item Modal -->
<div id="cancelItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-900">Cancel Items</h3>
      <button onclick="closeCancelItemModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>
    </div>
    <form id="cancelItemForm" class="p-6">
      <input type="hidden" id="cancelItemOrderId" name="orderId">

      <p class="text-sm text-gray-600 mb-4">Select items you want to cancel:</p>

      <!-- Items Selection -->
      <div id="cancelItemsList" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
        <!-- Items will be populated dynamically -->
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Cancellation *</label>
        <select name="reason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Select a reason</option>
          <option value="Changed my mind">Changed my mind</option>
          <option value="Found better price elsewhere">Found better price elsewhere</option>
          <option value="Ordered by mistake">Ordered by mistake</option>
          <option value="Delivery time too long">Delivery time too long</option>
          <option value="Product no longer needed">Product no longer needed</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Comments (Optional)</label>
        <textarea name="comments" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Enter any additional details..."></textarea>
      </div>
      <div class="flex gap-3">
        <button type="submit" class="flex-1 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
          Confirm Cancellation
        </button>
        <button type="button" onclick="closeCancelItemModal()" class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors">
          Close
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Return Single Item Modal -->
<div id="returnItemModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-900">Return Items</h3>
      <button onclick="closeReturnItemModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>
    </div>
    <form id="returnItemForm" class="p-6">
      <input type="hidden" id="returnItemOrderId" name="orderId">

      <p class="text-sm text-gray-600 mb-4">Select items you want to return:</p>

      <!-- Items Selection -->
      <div id="returnItemsList" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
        <!-- Items will be populated dynamically -->
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Return *</label>
        <select name="reason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Select a reason</option>
          <option value="Product damaged">Product damaged</option>
          <option value="Wrong product delivered">Wrong product delivered</option>
          <option value="Product not as described">Product not as described</option>
          <option value="Quality issues">Quality issues</option>
          <option value="Performance issues">Performance issues</option>
          <option value="Changed my mind">Changed my mind</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details (Optional)</label>
        <textarea name="comments" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Describe the issue in detail..."></textarea>
      </div>

      <div class="flex gap-3">
        <button type="submit" class="flex-1 px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition-colors">
          Submit Return Request
        </button>
        <button type="button" onclick="closeReturnItemModal()" class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors">
          Close
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full">
    <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-900">Cancel Order</h3>
      <button onclick="closeCancelModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>
    </div>
    <form id="cancelForm" class="p-6">
      <input type="hidden" id="cancelOrderId" name="orderId">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Cancellation *</label>
        <select name="reason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Select a reason</option>
          <option value="Changed my mind">Changed my mind</option>
          <option value="Found better price elsewhere">Found better price elsewhere</option>
          <option value="Ordered by mistake">Ordered by mistake</option>
          <option value="Delivery time too long">Delivery time too long</option>
          <option value="Product no longer needed">Product no longer needed</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Comments (Optional)</label>
        <textarea name="comments" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Enter any additional details..."></textarea>
      </div>
      <div class="flex gap-3">
        <button type="submit" class="flex-1 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
          Confirm Cancellation
        </button>
        <button type="button" onclick="closeCancelModal()" class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors">
          Close
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Return Order Modal -->
<div id="returnModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
      <h3 class="text-xl font-semibold text-gray-900">Return Items</h3>
      <button onclick="closeReturnModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>
    </div>
    <form id="returnForm" class="p-6">
      <input type="hidden" id="returnOrderId" name="orderId">

      <!-- Select Items to Return -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-3">Select Items to Return *</label>
        <div id="returnItemsList" class="space-y-2">
          <!-- Items will be populated dynamically -->
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Return *</label>
        <select name="reason" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Select a reason</option>
          <option value="Product damaged">Product damaged</option>
          <option value="Wrong product delivered">Wrong product delivered</option>
          <option value="Product not as described">Product not as described</option>
          <option value="Quality issues">Quality issues</option>
          <option value="Performance issues">Performance issues</option>
          <option value="Changed my mind">Changed my mind</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details (Optional)</label>
        <textarea name="comments" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Describe the issue in detail..."></textarea>
      </div>

      <div class="flex gap-3">
        <button type="submit" class="flex-1 px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition-colors">
          Submit Return Request
        </button>
        <button type="button" onclick="closeReturnModal()" class="px-6 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors">
          Close
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .filter-tab {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  .filter-tab.active {
    background-color: #2563eb;
    color: white;
  }

  .filter-tab:hover:not(.active) {
    background-color: #e5e7eb;
  }
</style>

<%
function getStatusClass(status) {
  const statusClasses = {
    'Pending': 'bg-yellow-100 text-yellow-700',
    'Confirmed': 'bg-blue-100 text-blue-700',
    'Processing': 'bg-purple-100 text-purple-700',
    'Shipped': 'bg-indigo-100 text-indigo-700',
    'Out for Delivery': 'bg-cyan-100 text-cyan-700',
    'Delivered': 'bg-green-100 text-green-700',
    'Cancelled': 'bg-red-100 text-red-700',
    'Returned': 'bg-orange-100 text-orange-700',
    'Partially Delivered': 'bg-teal-100 text-teal-700',
    'Partially Cancelled': 'bg-pink-100 text-pink-700',
    'Partially Returned': 'bg-amber-100 text-amber-700'
  };
  return statusClasses[status] || 'bg-gray-100 text-gray-700';
}

function getItemStatusClass(status) {
  const statusClasses = {
    'Pending': 'bg-yellow-100 text-yellow-700',
    'Confirmed': 'bg-blue-100 text-blue-700',
    'Processing': 'bg-purple-100 text-purple-700',
    'Shipped': 'bg-indigo-100 text-indigo-700',
    'Delivered': 'bg-green-100 text-green-700',
    'Cancelled': 'bg-red-100 text-red-700',
    'ReturnRequested': 'bg-orange-100 text-orange-700',
    'ReturnRejected': 'bg-red-100 text-red-700',
    'ReturnApproved': 'bg-blue-100 text-blue-700',
    'Returned': 'bg-orange-100 text-orange-700'
  };
  return statusClasses[status] || 'bg-gray-100 text-gray-700';
}
%>