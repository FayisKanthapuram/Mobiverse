<div class="min-h-screen bg-gray-50 py-8">
  <div class="container mx-auto px-4">
    <!-- Back Button -->
    <div class="mb-6">
      <a href="/orders" class="text-blue-600 hover:text-blue-700 font-semibold">
        <i class="bi bi-arrow-left"></i> Back to Orders
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Order Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
            <div>
              <h1 class="text-2xl font-bold text-gray-900 mb-2">Order #<%= order?.orderId %></h1>
              <div class="flex flex-wrap gap-3">
                <span class="px-3 py-1 rounded-full text-sm font-semibold <%= getStatusClass(order?.orderStatus) %>">
                  <%= order?.orderStatus %>
                </span>
                <span class="px-3 py-1 rounded-full text-sm font-semibold <%= order?.paymentStatus === 'Paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700' %>">
                  <%= order?.paymentStatus %>
                </span>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">Placed on</p>
              <p class="font-semibold text-gray-900">
                <%= order?.createdAt ? new Date(order.createdAt).toLocaleDateString('en-IN', { 
                  day: 'numeric', month: 'long', year: 'numeric' 
                }) : 'N/A' %>
              </p>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6">
            Order Items (<%= order?.orderedItems?.length || 0 %>)
          </h2>

          <div class="space-y-6">
            <% order?.orderedItems?.forEach(function(item) { %>
            <div class="border-2 rounded-xl p-4 <%= ['Cancelled', 'Returned'].includes(item?.itemStatus) ? 'border-gray-200 bg-gray-50' : ['ReturnRequested', 'ReturnApproved'].includes(item?.itemStatus) ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200' %>">

              <!-- Item Info -->
              <div class="flex gap-4 pb-4 border-b border-gray-200">
                <div class="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                  <img src="<%= item?.variantId?.images?.[0] || '/placeholder.jpg' %>" alt="<%= item?.productId?.name || 'Product' %>" class="w-full h-full object-contain">
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-start gap-2 mb-2">
                    <h3 class="font-semibold text-gray-900 flex-1"><%= item?.productId?.name || 'Product' %></h3>

                    <div class="flex gap-1 flex-wrap justify-end">
                      <span class="px-2 py-1 rounded text-xs font-semibold whitespace-nowrap <%= getItemStatusClass(item?.itemStatus) %>">
                        <%= item?.itemStatus?.replace(/([A-Z])/g, ' $1').trim() || 'Unknown' %>
                      </span>

                      <span class="px-2 py-1 rounded text-xs font-semibold whitespace-nowrap <%= getItemPaymentStatusClass(item?.paymentStatus) %>">
                        <%= 
                          item?.paymentStatus === 'Pending' && order?.paymentMethod === 'cod'
                            ? 'Pay on Delivery'
                            : item?.paymentStatus || 'Pending'
                        %>
                      </span>
                    </div>
                  </div>

                  <div class="flex flex-wrap gap-1.5 mb-2">
                    <% if (item?.variantId?.colour) { %>
                    <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                      <i class="bi bi-palette"></i> <%= item.variantId.colour %>
                    </span>
                    <% } %>
                    <% if (item?.variantId?.ram) { %>
                    <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                      <i class="bi bi-memory"></i> <%= item.variantId.ram %>
                    </span>
                    <% } %>
                    <% if (item?.variantId?.storage) { %>
                    <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                      <i class="bi bi-device-hdd"></i> <%= item.variantId.storage %>
                    </span>
                    <% } %>
                  </div>

                  <div class="flex justify-between items-center">
                    <p class="text-gray-600">
                      Quantity:
                      <span class="font-semibold text-gray-900"><%= item?.quantity || 0 %></span>
                    </p>

                    <div class="text-right leading-tight">
                      <% 
                        const qty = item?.quantity || 0;
                        const sale = item?.price || 0;
                        const regular = item?.regularPrice || sale;
                        const offer = item?.offer || 0;
                        const finalPrice = offer ? sale - offer  : sale ;
                      %>

                      <p class="font-bold <%= offer ? 'text-green-600' : 'text-gray-900' %>">
                        â‚¹<%= (finalPrice * qty).toLocaleString('en-IN') %>
                      </p>


                      <% if (offer) { %>
                      <p class="text-xs text-gray-500 line-through">
                        â‚¹<%= (sale * qty).toLocaleString('en-IN') %>
                      </p>
                      <% } %>

                      <% if (regular > sale) { %>
                      <p class="text-xs text-gray-500 line-through">
                        â‚¹<%= (regular * qty).toLocaleString('en-IN') %>
                      </p>
                      <% } %>
                    </div>
                  </div>
                  <% if (item?.itemStatus === 'Delivered' && !item?.isReviewed) { %>
                  <button onclick="openReviewModal(
                        '<%= item._id %>',
                        '<%= item.productId._id %>',
                        '<%= item.variantId._id %>'
                      )" class="mt-3 inline-flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100">
                    <i class="bi bi-star"></i> Write Review
                  </button>
                  <% } %>
                </div>
              </div>

              <!-- Item Tracking Timeline -->
              <div class="mt-4 pt-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <i class="bi bi-clock-history"></i>
                  Item Tracking
                </h4>

                <div class="relative">
                  <% const timeline = item?.itemTimeline || {}; %>

                  <!-- Vertical Line -->
                  <div class="absolute left-1.5 top-2 bottom-2 w-0.5 bg-gray-200"></div>

                  <div class="space-y-4 relative">
                    <!-- Order Placed -->
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-green-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-gray-900">Order Placed</div>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= order?.createdAt ? new Date(order.createdAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) : 'N/A' %>
                        </div>
                      </div>
                    </div>

                    <!-- Status Flow -->
                    <% [
                      {label: 'Confirmed', key: 'confirmedAt', icon: 'bi-check-circle'},
                      {label: 'Processing', key: 'processedAt', icon: 'bi-gear'},
                      {label: 'Shipped', key: 'shippedAt', icon: 'bi-box-seam'},
                      {label: 'Out for Delivery', key: 'outForDeliveryAt', icon: 'bi-truck'},
                      {label: 'Delivered', key: 'deliveredAt', icon: 'bi-house-check'}
                    ].forEach(function(step) { 
                      const isActive = timeline?.[step.key];
                      const isCurrentStatus = item?.itemStatus === step.label;
                    %>

                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full border-2 border-white <%= isActive ? 'bg-green-500' : isCurrentStatus ? 'bg-blue-500' : 'bg-gray-300' %>"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium <%= isActive ? 'text-gray-900' : 'text-gray-400' %>">
                          <i class="<%= step.icon %> mr-1"></i>
                          <%= step.label %>
                          <% if (isCurrentStatus && !isActive) { %>
                          <span class="text-blue-600 text-xs ml-2">(Current)</span>
                          <% } %>
                        </div>
                        <% if (isActive) { %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline[step.key]).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% } %>
                      </div>
                    </div>

                    <% }); %>

                    <!-- Cancelled Status -->
                    <% if (item?.itemStatus === 'Cancelled') { %>
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-red-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-red-600">
                          <i class="bi bi-x-circle mr-1"></i>
                          Cancelled
                        </div>
                        <% if (timeline?.cancelledAt) { %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline.cancelledAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% } %>
                        <% if (item?.reason) { %>
                        <div class="mt-2 p-3 bg-red-50 border-l-4 border-red-400 rounded text-xs text-gray-700">
                          <strong>Reason:</strong> <%= item.reason %>
                        </div>
                        <% } %>
                      </div>
                    </div>
                    <% } %>

                    <!-- Return Statuses -->
                    <% if (['ReturnRequested', 'ReturnApproved', 'ReturnRejected', 'Returned'].includes(item?.itemStatus)) { %>

                    <!-- Return Requested -->
                    <% if (timeline?.returnRequestedAt) { %>
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-yellow-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-yellow-700">
                          <i class="bi bi-arrow-return-left mr-1"></i>
                          Return Requested
                        </div>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline.returnRequestedAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% if (item?.reason) { %>
                        <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded text-xs text-gray-700">
                          <strong>Your reason:</strong> <%= item.reason %>
                        </div>
                        <% } %>
                      </div>
                    </div>
                    <% } %>

                    <!-- Return Approved -->
                    <% if (item?.itemStatus === 'ReturnApproved' || item?.itemStatus === 'Returned') { %>
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-blue-700">
                          <i class="bi bi-check-circle mr-1"></i>
                          Return Approved
                        </div>
                        <% if (timeline?.returnApprovedAt) { %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline.returnApprovedAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% } %>
                        <% if (item?.adminNote) { %>
                        <div class="mt-2 p-3 bg-blue-50 border-l-4 border-blue-400 rounded text-xs text-gray-700">
                          <strong>Admin note:</strong> <%= item.adminNote %>
                        </div>
                        <% } %>
                      </div>
                    </div>
                    <% } %>

                    <!-- Return Rejected -->
                    <% if (item?.itemStatus === 'ReturnRejected') { %>
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-red-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-red-700">
                          <i class="bi bi-x-circle mr-1"></i>
                          Return Rejected
                        </div>
                        <% if (timeline?.returnRejectedAt) { %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline.returnRejectedAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% } %>
                        <% if (item?.adminNote) { %>
                        <div class="mt-2 p-3 bg-red-50 border-l-4 border-red-400 rounded text-xs text-gray-700">
                          <strong>Admin note:</strong> <%= item.adminNote %>
                        </div>
                        <% } %>
                      </div>
                    </div>
                    <% } %>

                    <!-- Returned -->
                    <% if (item?.itemStatus === 'Returned') { %>
                    <div class="flex gap-4">
                      <div class="relative z-10">
                        <div class="w-4 h-4 rounded-full bg-orange-500 border-2 border-white"></div>
                      </div>
                      <div class="flex-1 -mt-1">
                        <div class="text-sm font-medium text-orange-700">
                          <i class="bi bi-box-seam mr-1"></i>
                          Item Returned
                        </div>
                        <% if (timeline?.returnedAt) { %>
                        <div class="text-xs text-gray-500 mt-0.5">
                          <%= new Date(timeline.returnedAt).toLocaleString('en-IN', { 
                            day: 'numeric', 
                            month: 'short', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) %>
                        </div>
                        <% } %>
                      </div>
                    </div>
                    <% } %>

                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">
            <i class="bi bi-geo-alt text-blue-600"></i> Shipping Address
          </h2>
          <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-semibold text-gray-900 mb-2"><%= order?.shippingAddress?.fullName || 'N/A' %></p>
            <p class="text-gray-700 text-sm">
              <%= order?.shippingAddress?.address1 || '' %><% if (order?.shippingAddress?.address2) { %>, <%= order.shippingAddress.address2 %><% } %><br>
              <%= order?.shippingAddress?.city || '' %>, <%= order?.shippingAddress?.state || '' %> - <%= order?.shippingAddress?.pincode || '' %><br>
              <%= order?.shippingAddress?.country || '' %>
            </p>
            <p class="text-gray-700 text-sm mt-2">
              <i class="bi bi-telephone"></i> <%= order?.shippingAddress?.phone || 'N/A' %>
            </p>
          </div>
        </div>

      </div>

      <!-- Order Summary Sidebar -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24 space-y-6">

          <!-- Payment Info -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-4">Payment Information</h3>
            <div class="space-y-3">
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <% if (order?.paymentMethod === 'razorpay') { %>
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <i class="bi bi-credit-card text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-900 text-sm">Online Payment</p>
                  <p class="text-xs text-gray-600">Razorpay</p>
                </div>
                <% } else if (order?.paymentMethod === 'wallet') { %>
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <i class="bi bi-wallet2 text-purple-600"></i>
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-900 text-sm">Wallet</p>
                  <p class="text-xs text-gray-600">Paid from wallet</p>
                </div>
                <% } else if (order?.paymentMethod === 'cod') { %>
                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                  <i class="bi bi-cash-coin text-orange-600"></i>
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-900 text-sm">Cash on Delivery</p>
                  <p class="text-xs text-gray-600">Pay when received</p>
                </div>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-4">Order Summary</h3>
            <div class="space-y-3">
              <div class="flex justify-between text-gray-700">
                <span>MRP (incl. of all taxes)</span>
                <span class="font-semibold">â‚¹<%= order?.subtotal?.toLocaleString('en-IN') || 0 %></span>
              </div>

              <% if (order?.discount > 0) { %>
              <div class="flex justify-between text-green-600">
                <span>Discount on MRP</span>
                <span class="font-semibold">-â‚¹<%= order.discount.toLocaleString('en-IN') %></span>
              </div>
              <% } %>

              <% if (order?.couponDiscount > 0) { %>
              <div class="flex justify-between text-green-600">
                <span>Coupon Applied</span>
                <span class="font-semibold">-â‚¹<%= order.couponDiscount.toLocaleString('en-IN') %></span>
              </div>
              <% } %>

              <div class="flex justify-between text-gray-700">
                <span>Delivery Charges</span>
                <% if (order?.deliveryCharge === 0) { %>
                <span class="font-semibold text-green-600">FREE</span>
                <% } else { %>
                <span class="font-semibold">â‚¹<%= order?.deliveryCharge?.toLocaleString('en-IN') || 0 %></span>
                <% } %>
              </div>

              <div class="pt-3 border-t border-gray-200">
                <div class="flex justify-between text-gray-900">
                  <span class="text-lg font-bold">Total</span>
                  <span class="text-2xl font-bold">â‚¹<%= order?.finalAmount?.toLocaleString('en-IN') || 0 %></span>
                </div>
              </div>
            </div>
          </div>

          <%
            const hasInvoiceEligibleItem = order?.orderedItems?.some(item =>
              ['Delivered', 'ReturnRequested', 'ReturnRejected'].includes(item?.itemStatus)
            );
          %>


          <!-- Actions -->
          <div class="space-y-2">
            <% if (hasInvoiceEligibleItem) { %>
            <button onclick="downloadInvoice('<%= order?.orderId %>')" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
              <i class="bi bi-download"></i> Download Invoice
            </button>
            <% } %>

            <a href="/contact" class="block w-full px-4 py-3 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors text-center">
              <i class="bi bi-headset"></i> Need Help?
            </a>
          </div>

          <!-- Expected Delivery -->
          <% if (order?.expectedDelivery && order?.orderStatus !== 'Delivered' && order?.orderStatus !== 'Cancelled' && order?.orderStatus !== 'Returned' && order?.orderStatus !== 'Partially Delivered' && order?.orderStatus !== 'Partially Cancelled' && order?.orderStatus !== 'Partially Returned') { %>
          <div class="p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-blue-700 font-medium">
              <i class="bi bi-truck"></i> Expected Delivery
            </p>
            <p class="text-lg font-bold text-blue-900 mt-1">
              <%= new Date(order.expectedDelivery).toLocaleDateString('en-IN', { 
                  day: 'numeric', month: 'short', year: 'numeric' 
                }) %>
            </p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" class="fixed inset-0 bg-gray-900 bg-opacity-20 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-lg">

      <h3 class="text-xl font-bold text-gray-900 mb-4">
        Rate this Product
      </h3>

      <form id="reviewForm">
        <input type="hidden" id="reviewOrderItemId">
        <input type="hidden" id="reviewProductId">
        <input type="hidden" id="reviewVariantId">

        <!-- Rating -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Rating
          </label>
          <div class="flex gap-2">
            <% for (let i = 1; i <= 5; i++) { %>
            <i class="bi bi-star text-2xl cursor-pointer text-gray-300" onclick="setRating(<%= i %>)" data-star="<%= i %>"></i>
            <% } %>
          </div>
          <input type="hidden" id="reviewRating" required>
        </div>

        <!-- Comment -->
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Comment
          </label>
          <textarea id="reviewComment" rows="4" maxlength="300" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Share your experience..." required></textarea>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeReviewModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Submit Review
          </button>
        </div>
      </form>

    </div>
  </div>


</div>

<script>
  function downloadInvoice(orderId) {
    window.open(`/order/invoice/${orderId}`, '_blank');
  }
</script>

<%
function getStatusClass(status) {
  const statusClasses = {
    'Pending': 'bg-yellow-100 text-yellow-700',
    'Confirmed': 'bg-blue-100 text-blue-700',
    'Processing': 'bg-purple-100 text-purple-700',
    'Shipped': 'bg-indigo-100 text-indigo-700',
    'Out for Delivery': 'bg-cyan-100 text-cyan-700',
    'Delivered': 'bg-green-100 text-green-700',
    'Cancelled': 'bg-red-100 text-red-700',
    'Returned': 'bg-orange-100 text-orange-700',
    'Partially Delivered': 'bg-teal-100 text-teal-700',
    'Partially Cancelled': 'bg-pink-100 text-pink-700',
    'Partially Returned': 'bg-amber-100 text-amber-700'
  };
  return statusClasses[status] || 'bg-gray-100 text-gray-700';
}

function getItemStatusClass(status) {
  const statusClasses = {
    'Pending': 'bg-yellow-100 text-yellow-700',
    'Confirmed': 'bg-blue-100 text-blue-700',
    'Processing': 'bg-purple-100 text-purple-700',
    'Shipped': 'bg-indigo-100 text-indigo-700',
    'Delivered': 'bg-green-100 text-green-700',
    'Cancelled': 'bg-red-100 text-red-700',
    'ReturnRequested': 'bg-yellow-100 text-yellow-700',
    'ReturnRejected': 'bg-red-100 text-red-700',
    'ReturnApproved': 'bg-blue-100 text-blue-700',
    'Returned': 'bg-orange-100 text-orange-700'
  };
  return statusClasses[status] || 'bg-gray-100 text-gray-700';
}

function getItemPaymentStatusClass(status) {
  const statusClasses = {
    'Pending': 'bg-yellow-100 text-yellow-700',
    'Paid': 'bg-green-100 text-green-700',
    'Refunded': 'bg-blue-100 text-blue-700',
    'Failed': 'bg-red-100 text-red-700',
    'Cancelled': 'bg-gray-200 text-gray-700'
  };
  return statusClasses[status] || 'bg-gray-100 text-gray-700';
}
%>

<script>
  let selectedRating = 0;

  function openReviewModal(orderItemId, productId, variantId) {
    document.getElementById('reviewModal').classList.remove('hidden');
    document.getElementById('reviewModal').classList.add('flex');

    document.getElementById('reviewOrderItemId').value = orderItemId;
    document.getElementById('reviewProductId').value = productId;
    document.getElementById('reviewVariantId').value = variantId;

    setRating(0);
    document.getElementById('reviewComment').value = '';
  }

  function closeReviewModal() {
    document.getElementById('reviewModal').classList.add('hidden');
    document.getElementById('reviewModal').classList.remove('flex');
  }

  function setRating(rating) {
    selectedRating = rating;
    document.getElementById('reviewRating').value = rating;

    document.querySelectorAll('[data-star]').forEach(star => {
      star.classList.toggle(
        'text-yellow-400',
        star.dataset.star <= rating
      );
      star.classList.toggle(
        'text-gray-300',
        star.dataset.star > rating
      );
    });
  }

  document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!selectedRating) {
      Toastify({
        text: "Please select a rating",
        duration: 3000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#f59e0b", // yellow
      }).showToast();
      return;
    }

    const payload = {
      orderItemId: document.getElementById('reviewOrderItemId').value,
      productId: document.getElementById('reviewProductId').value,
      variantId: document.getElementById('reviewVariantId').value,
      rating: selectedRating,
      comment: document.getElementById('reviewComment').value,
    };

    try {
      await axios.post('/reviews', payload);

      Toastify({
        text: "Review submitted successfully ðŸŽ‰",
        duration: 3000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#22c55e", // green
      }).showToast();

      closeReviewModal();

      // Small delay for UX
      setTimeout(() => {
        location.reload();
      }, 1200);

    } catch (error) {
      Toastify({
        text: error?.response?.data?.message ||
          "Failed to submit review. Try again.",
        duration: 4000,
        gravity: "bottom",
        position: "right",
        backgroundColor: "#ef4444", // red
      }).showToast();
    }
  });
</script>