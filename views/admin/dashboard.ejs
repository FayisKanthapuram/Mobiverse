<!-- Dashboard Header -->
<div class="mb-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Dashboard</h1>
  <p class="text-gray-600">Welcome back! Here's what's happening with your store today.</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <!-- Total Revenue -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
        <i class="bi bi-currency-rupee text-2xl text-blue-600"></i>
      </div>
      <span class="text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded">+12.5%</span>
    </div>
    <h3 class="text-gray-600 text-sm font-medium mb-1">Total Revenue</h3>
    <p class="text-2xl font-bold text-gray-900" id="total-revenue">
      <span class="inline-block w-20 h-8 bg-gray-200 animate-pulse rounded"></span>
    </p>
  </div>

  <!-- Total Orders -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
        <i class="bi bi-cart-check text-2xl text-purple-600"></i>
      </div>
      <span class="text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded">+8.2%</span>
    </div>
    <h3 class="text-gray-600 text-sm font-medium mb-1">Total Orders</h3>
    <p class="text-2xl font-bold text-gray-900" id="total-orders">
      <span class="inline-block w-16 h-8 bg-gray-200 animate-pulse rounded"></span>
    </p>
  </div>

  <!-- Total Users -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
        <i class="bi bi-people text-2xl text-green-600"></i>
      </div>
      <span class="text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded">+15.3%</span>
    </div>
    <h3 class="text-gray-600 text-sm font-medium mb-1">Total Users</h3>
    <p class="text-2xl font-bold text-gray-900" id="total-users">
      <span class="inline-block w-16 h-8 bg-gray-200 animate-pulse rounded"></span>
    </p>
  </div>

  <!-- Total Products -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
        <i class="bi bi-phone text-2xl text-orange-600"></i>
      </div>
      <span class="text-sm font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">Active</span>
    </div>
    <h3 class="text-gray-600 text-sm font-medium mb-1">Total Products</h3>
    <p class="text-2xl font-bold text-gray-900" id="total-products">
      <span class="inline-block w-16 h-8 bg-gray-200 animate-pulse rounded"></span>
    </p>
  </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Sales Chart -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Sales Overview</h2>
        <p class="text-sm text-gray-600">Revenue and order trends</p>
      </div>

      <select
        id="sales-filter"
        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white"
      >
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>

    <!-- ðŸ”¥ FIX: FIXED HEIGHT WRAPPER -->
    <div class="relative h-[320px]">
      <canvas id="salesChart"></canvas>
    </div>
  </div>


  <!-- Order Status Chart -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-1">Order Status</h2>
      <p class="text-sm text-gray-600">Distribution of order statuses</p>
    </div>

    <!-- ðŸ”¥ FIX -->
    <div class="relative h-[320px]">
      <canvas id="orderStatusChart"></canvas>
    </div>
  </div>
</div>




<!-- Top Selling Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Top 10 Products -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Top 10 Products</h2>
      <i class="bi bi-trophy-fill text-2xl text-yellow-500"></i>
    </div>
    <div id="top-products" class="space-y-4">
      <!-- Loading skeleton -->
      <div class="text-center py-8">
        <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-500 text-sm mt-2">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Top 10 Brands -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Top 10 Brands</h2>
      <i class="bi bi-award-fill text-2xl text-blue-500"></i>
    </div>
    <div id="top-brands" class="space-y-4">
      <!-- Loading skeleton -->
      <div class="text-center py-8">
        <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-500 text-sm mt-2">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Recent Orders -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Recent Orders</h2>
      <a href="/admin/orders" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All</a>
    </div>
    <div id="recent-orders" class="space-y-4">
      <!-- Loading skeleton -->
      <div class="text-center py-8">
        <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-500 text-sm mt-2">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
// Global variables for charts
let salesChart = null;
let orderStatusChart = null;
let referralChart = null;

// Format currency
function formatCurrency(amount) {
  return 'â‚¹' + amount.toLocaleString('en-IN');
}

// Show error message
function showError(message) {
  Toastify({
    text: message,
    duration: 4000,
    gravity: "bottom",
    position: "right",
    style: {
      background: "#e74c3c",
    },
    close: true,
  }).showToast();
}

// Fetch Dashboard Stats
async function fetchDashboardStats() {
  try {
    const response = await axios.get('/admin/dashboard/api/stats');
    
    if (response.data.success) {
      const { revenue, orders, users, products } = response.data.data;
      
      document.getElementById('total-revenue').textContent = formatCurrency(revenue);
      document.getElementById('total-orders').textContent = orders.toLocaleString();
      document.getElementById('total-users').textContent = users.toLocaleString();
      document.getElementById('total-products').textContent = products.toLocaleString();
    }
  } catch (error) {
    console.error('Error fetching dashboard stats:', error);
    showError('Failed to load dashboard statistics');
  }
}

// Fetch Sales Chart Data
async function fetchSalesChartData(filter = 'weekly') {
  try {
    const response = await axios.get(`/admin/dashboard/api/sales-chart?filter=${filter}`);
    // console.log(response.data.data)
    if (response.data.success) {
      const { labels, data } = response.data.data;
      
      if (salesChart) {
        salesChart.data.labels = labels;
        salesChart.data.datasets[0].data = data;
        salesChart.update();
      } else {
        initializeSalesChart(labels, data);
      }
    }
  } catch (error) {
    console.error('Error fetching sales chart data:', error);
    showError('Failed to load sales chart');
  }
}

// Fetch Order Status Data
async function fetchOrderStatusData() {
  try {
    const response = await axios.get('/admin/dashboard/api/order-status');
    if (response.data.success) {
      const { labels, data } = response.data.data;
      initializeOrderStatusChart(labels, data);
    }
  } catch (error) {
    console.error('Error fetching order status data:', error);
    showError('Failed to load order status chart');
  }
}

// Fetch Top Products
async function fetchTopProducts() {
  try {
    const response = await axios.get('/admin/dashboard/api/top-products');
    
    if (response.data.success) {
      renderTopProducts(response.data.data);
    }
  } catch (error) {
    console.error('Error fetching top products:', error);
    document.getElementById('top-products').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load products</div>';
  }
}

// Fetch Top Brands
async function fetchTopBrands() {
  try {
    const response = await axios.get('/admin/dashboard/api/top-brands');
    
    if (response.data.success) {
      renderTopBrands(response.data.data);
    }
  } catch (error) {
    console.error('Error fetching top brands:', error);
    document.getElementById('top-brands').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load brands</div>';
  }
}

// Fetch Recent Orders
async function fetchRecentOrders() {
  try {
    const response = await axios.get('/admin/dashboard/api/recent-orders');
    
    if (response.data.success) {
      renderRecentOrders(response.data.data);
    }
  } catch (error) {
    console.error('Error fetching recent orders:', error);
    document.getElementById('recent-orders').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load orders</div>';
  }
}

// Initialize Sales Chart
function initializeSalesChart(labels, data) {
  const ctx = document.getElementById("salesChart");

  if (salesChart) {
    salesChart.destroy();
  }

  salesChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Revenue",
          data,
          tension: 0.4,
          fill: true,
          borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        y: { beginAtZero: true },
      },
    },
  });
}

const ORDER_STATUS_COLORS = {
  Pending: "#fb923c",              // orange-400
  Confirmed: "#60a5fa",             // blue-400
  Processing: "#facc15",            // yellow-400
  Shipped: "#38bdf8",               // sky-400
  "Out for Delivery": "#a78bfa",     // violet-400
  Delivered: "#22c55e",             // green-500
  Cancelled: "#ef4444",             // red-500
  Returned: "#8b5cf6",              // purple-500
  "Partially Delivered": "#10b981", // emerald-500
  "Partially Cancelled": "#f97316", // orange-500
  "Partially Returned": "#c084fc",  // purple-400
};

// Initialize Order Status Chart
function initializeOrderStatusChart(labels, data) {
  const ctx = document.getElementById("orderStatusChart");

  if (orderStatusChart) {
    orderStatusChart.destroy();
  }

  // Map colors based on status labels
  const backgroundColors = labels.map(
    (status) => ORDER_STATUS_COLORS[status] || "#9ca3af" // gray-400 fallback
  );

  orderStatusChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [
        {
          data,
          backgroundColor: backgroundColors,
          borderWidth: 2,
          borderColor: "#ffffff",
          hoverOffset: 8,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: "65%",
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            usePointStyle: true,
            boxWidth: 10,
            padding: 16,
            font: {
              size: 12,
              weight: "500",
            },
          },
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return `${context.label}: ${context.raw}`;
            },
          },
        },
      },
    },
  });
}

// Initialize Referral Chart
function initializeReferralChart(labels, referrals, conversions) {
  const ctx = document.getElementById("referralChart");

  if (referralChart) {
    referralChart.destroy();
  }

  referralChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "New Referrals",
          data: referrals,
          borderRadius: 6,
        },
        {
          label: "Conversions",
          data: conversions,
          borderRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
      },
      scales: {
        y: { beginAtZero: true },
      },
    },
  });
}

// Render Top Products
function renderTopProducts(products) {
  const container = document.getElementById('top-products');
  
  if (products.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-gray-500">No products data available</div>';
    return;
  }
  
  container.innerHTML = products.map(product => `
    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
          ${product.rank}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">${product.name}</p>
          <p class="text-xs text-gray-500">${product.sales} sales</p>
        </div>
      </div>
      <div class="text-right ml-2">
        <p class="text-sm font-semibold text-gray-900">${formatCurrency(product.revenue)}</p>
      </div>
    </div>
  `).join('');
}

// Render Top Brands
function renderTopBrands(brands) {
  const container = document.getElementById('top-brands');
  
  if (brands.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-gray-500">No brands data available</div>';
    return;
  }
  
  const colors = ['blue', 'purple', 'green', 'orange', 'pink', 'indigo', 'red', 'yellow', 'teal', 'cyan'];
  
  container.innerHTML = brands.map((brand, index) => `
    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors">
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
          ${brand.rank}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">${brand.name}</p>
          <p class="text-xs text-gray-500">${brand.sales} sales</p>
        </div>
      </div>
      <div class="text-right ml-2">
        <p class="text-sm font-semibold text-gray-900">${formatCurrency(brand.revenue)}</p>
      </div>
    </div>
  `).join('');
}

// Render Recent Orders
function renderRecentOrders(orders) {
  const container = document.getElementById('recent-orders');
  
  if (orders.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-gray-500">No recent orders</div>';
    return;
  }
  
  const statusColors = {
    'Delivered': 'bg-green-100 text-green-700',
    'Shipped': 'bg-blue-100 text-blue-700',
    'Processing': 'bg-yellow-100 text-yellow-700',
    'Pending': 'bg-orange-100 text-orange-700',
    'Cancelled': 'bg-red-100 text-red-700',
    'Returned': 'bg-purple-100 text-purple-700'
  };
  
  container.innerHTML = orders.map(order => `
    <div class="p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-100">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm font-semibold text-gray-900">${order.id}</p>
        <span class="text-xs px-2 py-1 rounded-full font-medium ${statusColors[order.status] || 'bg-gray-100 text-gray-700'}">${order.status}</span>
      </div>
      <p class="text-xs text-gray-600 mb-1">${order.customer}</p>
      <p class="text-sm font-semibold text-gray-900">${formatCurrency(order.amount)}</p>
    </div>
  `).join('');
}

// Filter event listeners
document.getElementById('sales-filter').addEventListener('change', function(e) {
  fetchSalesChartData(e.target.value);
});

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
  // Fetch all data
  fetchDashboardStats();
  fetchSalesChartData();
  fetchOrderStatusData();
  fetchTopProducts();
  fetchTopBrands();
  fetchRecentOrders();
});
</script>