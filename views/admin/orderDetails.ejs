<!-- Order Details Page -->
<div class="page-container" data-order-id="<%= order._id %>">
  <!-- Header with Back Button -->
  <div class="page-header">
    <div class="header-left">
      <a href="/admin/orders" class="back-btn">
        <i class="bi bi-arrow-left"></i>
      </a>
      <div>
        <h1>Order Details</h1>
        <p class="subtitle">Order ID: <strong>#<%= order.orderId %></strong></p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" onclick="printOrder()">
        <i class="bi bi-printer"></i>
        Print
      </button>
      <button class="btn-primary" onclick="downloadInvoice()">
        <i class="bi bi-download"></i>
        Invoice
      </button>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="details-grid">
    <!-- Left Column -->
    <div class="left-column">
      <!-- Return Requests Alert (if any) -->
      <% 
        const hasReturnRequests = order.orderedItems.some(item => item.itemStatus === 'ReturnRequested');
        const hasApprovedReturns = order.orderedItems.some(item => item.itemStatus === 'ReturnApproved');
      %>

      <% if (hasReturnRequests) { %>
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <div class="alert-content">
          <strong>Return Requests Pending</strong>
          <p>There are items waiting for your return approval decision.</p>
        </div>
      </div>
      <% } %>

      <% if (hasApprovedReturns) { %>
      <div class="alert alert-info">
        <i class="bi bi-box-seam"></i>
        <div class="alert-content">
          <strong>Approved Returns</strong>
          <p>Items are approved for return. Mark them as returned once received.</p>
        </div>
      </div>
      <% } %>

      <!-- Order Status Card -->
      <div class="card">
        <div class="card-header">
          <h3>Order Status</h3>
          <% 
            let statusClass = '';
            if (order.orderStatus === 'Delivered') statusClass = 'status-active';
            else if (order.orderStatus === 'Shipped' || order.orderStatus === 'Out for Delivery') statusClass = 'status-shipping';
            else if (order.orderStatus === 'Pending') statusClass = 'status-pending';
            else if (order.orderStatus === 'Confirmed' || order.orderStatus === 'Processing') statusClass = 'status-processing';
            else if (order.orderStatus === 'Cancelled') statusClass = 'status-blocked';
            else if (order.orderStatus === 'Returned' || order.orderStatus === 'Partially Returned') statusClass = 'status-returned';
          %>
          <span class="status-badge <%= statusClass %>"><%= order.orderStatus %></span>
        </div>
        <div class="card-body">
          <%
            const activeItemExists = order.orderedItems.some(item =>
              ["Pending", "Confirmed", "Processing", "Shipped", "Out for Delivery"]
                .includes(item.itemStatus)
            );
          %>
          <% if (activeItemExists) { %>
          <div class="status-update-section">
            <label for="statusSelect">Update Order Status</label>
            <div class="status-update-controls">
              <select id="statusSelect" class="form-select">
                <option value="Pending" <%= order.orderStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
                <option value="Confirmed" <%= order.orderStatus === 'Confirmed' ? 'selected' : '' %>>Confirmed</option>
                <option value="Processing" <%= order.orderStatus === 'Processing' ? 'selected' : '' %>>Processing</option>
                <option value="Shipped" <%= order.orderStatus === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                <option value="Out for Delivery" <%= order.orderStatus === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
                <option value="Delivered" <%= order.orderStatus === 'Delivered' ? 'selected' : '' %>>Delivered</option>
              </select>
              <button class="btn-primary" onclick="updateOrderStatus()">Update</button>
            </div>
            <p class="status-note"><i class="bi bi-info-circle"></i> Cancel and Return are user-initiated actions</p>
          </div>
          <% } %>

          <!-- Order Timeline -->
          <div class="timeline">
            <div class="timeline-item <%= order.createdAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Order Placed</div>
                <% if (order.createdAt) { %>
                <div class="timeline-date"><%= new Date(order.createdAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <div class="timeline-item <%= order.statusTimeline?.confirmedAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Confirmed</div>
                <% if (order.statusTimeline?.confirmedAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.confirmedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <div class="timeline-item <%= order.statusTimeline?.processedAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Processing</div>
                <% if (order.statusTimeline?.processedAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.processedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <div class="timeline-item <%= order.statusTimeline?.shippedAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Shipped</div>
                <% if (order.statusTimeline?.shippedAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.shippedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <div class="timeline-item <%= order.statusTimeline?.outForDeliveryAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Out for Delivery</div>
                <% if (order.statusTimeline?.outForDeliveryAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.outForDeliveryAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <div class="timeline-item <%= order.statusTimeline?.deliveredAt ? 'completed' : '' %>">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Delivered</div>
                <% if (order.statusTimeline?.deliveredAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.deliveredAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>

            <% if (order.orderStatus === 'Cancelled' || order.statusTimeline?.cancelledAt) { %>
            <div class="timeline-item completed cancelled">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Cancelled</div>
                <% if (order.statusTimeline?.cancelledAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.cancelledAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>
            <% } %>

            <% if (order.orderStatus === 'Returned' || order.statusTimeline?.returnedAt) { %>
            <div class="timeline-item completed returned">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Returned</div>
                <% if (order.statusTimeline?.returnedAt) { %>
                <div class="timeline-date"><%= new Date(order.statusTimeline.returnedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
                <% } %>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Ordered Items -->
      <div class="card">
        <div class="card-header">
          <h3>Ordered Items (<%= order.orderedItems.length %>)</h3>
        </div>
        <div class="card-body">
          <div class="items-list">
            <% order.orderedItems.forEach(item => { %>
            <div class="item-card <%= item.itemStatus === 'ReturnRequested' ? 'return-requested' : '' %> <%= item.itemStatus === 'ReturnApproved' ? 'return-approved' : '' %>">
              <div class="item-main-content">
                <div class="item-image">
                  <% if (item.variantId.images && item.variantId.images.length > 0) { %>
                  <img src="<%= item.variantId.images[0] %>" alt="<%= item.productId.name %>">
                  <% } else { %>
                  <div class="no-image">
                    <i class="bi bi-image"></i>
                  </div>
                  <% } %>
                </div>
                <div class="item-details">
                  <div class="item-name"><%= item.productId?.name || 'Product' %></div>
                  <div class="item-variant">
                    <% if (item.variantId?.color) { %>
                    <span>Color: <%= item.variantId.color %></span>
                    <% } %>
                    <% if (item.variantId?.storage) { %>
                    <span>Storage: <%= item.variantId.storage %></span>
                    <% } %>
                    <% if (item.variantId?.ram) { %>
                    <span>RAM: <%= item.variantId.ram %></span>
                    <% } %>
                  </div>
                  <div class="item-quantity">Quantity: <strong><%= item.quantity %></strong></div>
                  <% if (item.itemStatus) { %>
                  <div class="item-status-row">
                    Status:
                    <% 
                          let itemStatusClass = '';
                          if (item.itemStatus === 'Delivered') itemStatusClass = 'status-active';
                          else if (item.itemStatus === 'Shipped') itemStatusClass = 'status-shipping';
                          else if (item.itemStatus === 'Pending') itemStatusClass = 'status-pending';
                          else if (item.itemStatus === 'Confirmed' || item.itemStatus === 'Processing') itemStatusClass = 'status-processing';
                          else if (item.itemStatus === 'Cancelled') itemStatusClass = 'status-blocked';
                          else if (item.itemStatus === 'Returned') itemStatusClass = 'status-returned';
                          else if (item.itemStatus === 'ReturnRequested' || item.itemStatus === 'ReturnApproved') itemStatusClass = 'status-refunded';
                          else if (item.itemStatus === 'ReturnRejected') itemStatusClass = 'status-blocked';
                        %>
                    <span class="status-badge <%= itemStatusClass %>"><%= item.itemStatus %></span>
                  </div>
                  <% } %>
                </div>
                <div class="item-price">
                  <div class="price-label">Price</div>
                  <div class="price-value">₹<%= (item.price * item.quantity).toLocaleString('en-IN', {minimumFractionDigits: 2}) %></div>
                  <div class="price-per-unit">₹<%= item.price.toLocaleString('en-IN') %> each</div>
                </div>
              </div>

              <!-- Return Request Section -->
              <% if (item.itemStatus === 'ReturnRequested') { %>
              <div class="return-request-section">
                <div class="return-header">
                  <i class="bi bi-arrow-return-left"></i>
                  <strong>Return Request</strong>
                </div>
                <div class="return-reason">
                  <label>Customer Reason:</label>
                  <p><%= item.reason || 'No reason provided' %></p>
                </div>
                <% if (item.itemTimeline?.returnRequestedAt) { %>
                <div class="return-date">
                  Requested: <%= new Date(item.itemTimeline.returnRequestedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                </div>
                <% } %>
                <div class="return-actions">
                  <div class="admin-note-input">
                    <label for="adminNote_<%= item._id %>">Admin Note (Optional)</label>
                    <textarea id="adminNote_<%= item._id %>" class="form-textarea" rows="2" placeholder="Add a note for approval/rejection..."></textarea>
                  </div>
                  <div class="return-buttons">
                    <button class="btn-reject" onclick="handleReturn('<%= order._id %>', '<%= item._id %>', 'reject')">
                      <i class="bi bi-x-circle"></i>
                      Reject
                    </button>
                    <button class="btn-approve" onclick="handleReturn('<%= order._id %>', '<%= item._id %>', 'approve')">
                      <i class="bi bi-check-circle"></i>
                      Approve
                    </button>
                  </div>
                </div>
              </div>
              <% } %>

              <!-- Approved Return Section -->
              <% if (item.itemStatus === 'ReturnApproved') { %>
              <div class="approved-return-section">
                <div class="approved-header">
                  <i class="bi bi-check-circle-fill"></i>
                  <strong>Return Approved</strong>
                </div>
                <% if (item.reason) { %>
                <div class="approved-reason">
                  <label>Reason:</label>
                  <p><%= item.reason %></p>
                </div>
                <% } %>
                <% if (item.itemTimeline?.returnApprovedAt) { %>
                <div class="approved-date">
                  Approved: <%= new Date(item.itemTimeline.returnApprovedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                </div>
                <% } %>
                <button class="btn-mark-returned" onclick="markItemReturned('<%= order._id %>', '<%= item._id %>')">
                  <i class="bi bi-box-seam"></i>
                  Mark as Returned
                </button>
              </div>
              <% } %>

              <!-- Cancelled Item Info -->
              <% if (item.itemStatus === 'Cancelled' && item.reason) { %>
              <div class="cancelled-section">
                <div class="cancelled-header">
                  <i class="bi bi-x-circle-fill"></i>
                  <strong>Cancelled by Customer</strong>
                </div>
                <div class="cancelled-reason">
                  <label>Reason:</label>
                  <p><%= item.reason %></p>
                </div>
                <% if (item.itemTimeline?.cancelledAt) { %>
                <div class="cancelled-date">
                  Cancelled: <%= new Date(item.itemTimeline.cancelledAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                </div>
                <% } %>
              </div>
              <% } %>

              <!-- Returned Item Info -->
              <% if (item.itemStatus === 'Returned' && item.reason) { %>
              <div class="returned-section">
                <div class="returned-header">
                  <i class="bi bi-arrow-return-left"></i>
                  <strong>Item Returned</strong>
                </div>
                <div class="returned-reason">
                  <label>Reason:</label>
                  <p><%= item.reason %></p>
                </div>
                <% if (item.itemTimeline?.returnedAt) { %>
                <div class="returned-date">
                  Returned: <%= new Date(item.itemTimeline.returnedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                </div>
                <% } %>
              </div>
              <% } %>

              <!-- Rejected Return Info -->
              <% if (item.itemStatus === 'ReturnRejected' && item.reason) { %>
              <div class="rejected-section">
                <div class="rejected-header">
                  <i class="bi bi-x-circle-fill"></i>
                  <strong>Return Rejected</strong>
                </div>
                <div class="rejected-reason">
                  <label>Reason:</label>
                  <p><%= item.reason %></p>
                </div>
                <% if (item.itemTimeline?.returnRejectedAt) { %>
                <div class="rejected-date">
                  Rejected: <%= new Date(item.itemTimeline.returnRejectedAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                </div>
                <% } %>
              </div>
              <% } %>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="right-column">
      <!-- Customer Information -->
      <div class="card">
        <div class="card-header">
          <h3>Customer Information</h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Name</span>
            <span class="info-value"><%= order.userId?.username || 'N/A' %></span>
          </div>
          <div class="info-row">
            <span class="info-label">Email</span>
            <span class="info-value"><%= order.userId?.email || 'N/A' %></span>
          </div>
          <div class="info-row">
            <span class="info-label">Phone</span>
            <span class="info-value"><%= order.userId?.phone || order.shippingAddress?.phone || 'N/A' %></span>
          </div>
        </div>
      </div>

      <!-- Shipping Address -->
      <div class="card">
        <div class="card-header">
          <h3>Shipping Address</h3>
          <% if (order.shippingAddress?.addressType) { %>
          <span class="address-type-badge"><%= order.shippingAddress.addressType %></span>
          <% } %>
        </div>
        <div class="card-body">
          <div class="address-content">
            <div class="address-name"><%= order.shippingAddress?.fullName || 'N/A' %></div>
            <div class="address-phone"><%= order.shippingAddress?.phone || 'N/A' %></div>
            <div class="address-line"><%= order.shippingAddress?.address1 || '' %></div>
            <% if (order.shippingAddress?.address2) { %>
            <div class="address-line"><%= order.shippingAddress.address2 %></div>
            <% } %>
            <div class="address-line">
              <%= order.shippingAddress?.city || '' %>,
              <%= order.shippingAddress?.state || '' %> -
              <%= order.shippingAddress?.pincode || '' %>
            </div>
            <div class="address-line"><%= order.shippingAddress?.country || '' %></div>
          </div>
        </div>
      </div>

      <!-- Payment Information -->
      <div class="card">
        <div class="card-header">
          <h3>Payment Information</h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Payment Method</span>
            <span class="info-value payment-method">
              <% if (order.paymentMethod === 'razorpay') { %>
              <i class="bi bi-credit-card"></i> Razorpay
              <% } else if (order.paymentMethod === 'cod') { %>
              <i class="bi bi-cash"></i> Cash on Delivery
              <% } else if (order.paymentMethod === 'wallet') { %>
              <i class="bi bi-wallet2"></i> Wallet
              <% } %>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Payment Status</span>
            <% 
              let paymentClass = '';
              if (order.paymentStatus === 'Paid') paymentClass = 'status-active';
              else if (order.paymentStatus === 'Pending') paymentClass = 'status-pending';
              else if (order.paymentStatus === 'Failed') paymentClass = 'status-blocked';
              else if (order.paymentStatus === 'Refunded') paymentClass = 'status-refunded';
            %>
            <span class="status-badge <%= paymentClass %>"><%= order.paymentStatus %></span>
          </div>

          <!-- Payment Status Update Section -->
          <div class="payment-status-update-section">
            <label for="paymentStatusSelect">Update Payment Status</label>
            <div class="status-update-controls">
              <select id="paymentStatusSelect" class="form-select">
                <option value="Pending" <%= order.paymentStatus === 'Pending' ? 'selected' : '' %>>Pending</option>
                <option value="Paid" <%= order.paymentStatus === 'Paid' ? 'selected' : '' %>>Paid</option>
                <option value="Failed" <%= order.paymentStatus === 'Failed' ? 'selected' : '' %>>Failed</option>
                <option value="Refunded" <%= order.paymentStatus === 'Refunded' ? 'selected' : '' %>>Refunded</option>
              </select>
              <button class="btn-primary btn-update-payment" onclick="updatePaymentStatus()">
                <i class="bi bi-check-circle"></i>
                Update
              </button>
            </div>
          </div>

          <% if (order.paymentInfo?.razorpayPaymentId) { %>
          <div class="info-row">
            <span class="info-label">Payment ID</span>
            <span class="info-value payment-id"><%= order.paymentInfo.razorpayPaymentId %></span>
          </div>
          <% } %>
          <% if (order.paymentInfo?.razorpayOrderId) { %>
          <div class="info-row">
            <span class="info-label">Razorpay Order ID</span>
            <span class="info-value payment-id"><%= order.paymentInfo.razorpayOrderId %></span>
          </div>
          <% } %>
          <% if (order.paymentInfo?.walletTransactionId) { %>
          <div class="info-row">
            <span class="info-label">Transaction ID</span>
            <span class="info-value payment-id"><%= order.paymentInfo.walletTransactionId %></span>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="card">
        <div class="card-header">
          <h3>Order Summary</h3>
        </div>
        <div class="card-body">
          <div class="summary-row">
            <span>Subtotal</span>
            <span>₹<%= order.subtotal.toLocaleString('en-IN', {minimumFractionDigits: 2}) %></span>
          </div>
          <% if (order.discount > 0) { %>
          <div class="summary-row discount">
            <span>Discount</span>
            <span>-₹<%= order.discount.toLocaleString('en-IN', {minimumFractionDigits: 2}) %></span>
          </div>
          <% } %>
          <div class="summary-row">
            <span>Delivery Charge</span>
            <span>
              <% if (order.deliveryCharge === 0) { %>
              <span class="free-delivery">FREE</span>
              <% } else { %>
              ₹<%= order.deliveryCharge.toLocaleString('en-IN', {minimumFractionDigits: 2}) %>
              <% } %>
            </span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total">
            <span>Total Amount</span>
            <span>₹<%= order.finalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2}) %></span>
          </div>
        </div>
      </div>

      <!-- Delivery Information -->
      <% if (order.expectedDelivery || order.deliveredDate) { %>
      <div class="card">
        <div class="card-header">
          <h3>Delivery Information</h3>
        </div>
        <div class="card-body">
          <% if (order.expectedDelivery) { %>
          <div class="info-row">
            <span class="info-label">Expected Delivery</span>
            <span class="info-value"><%= new Date(order.expectedDelivery).toLocaleDateString('en-IN', { dateStyle: 'long' }) %></span>
          </div>
          <% } %>
          <% if (order.deliveredDate) { %>
          <div class="info-row">
            <span class="info-label">Delivered On</span>
            <span class="info-value"><%= new Date(order.deliveredDate).toLocaleDateString('en-IN', { dateStyle: 'long' }) %></span>
          </div>
          <% } %>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>