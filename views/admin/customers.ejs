<div class="main-header">
  <div class="header-left">
    <h2>Customers Management</h2>
    <p>Manage and monitor all customers in your marketplace.</p>
  </div>
</div>

<div class="stats-container">
  <div class="stat-card total">
    <div class="icon-wrapper"> <i class="fas fa-users"></i> </div>
    <div class="stat-info"> <span>Total Users</span>
      <h3><%= totalCustomersCound %></h3>
    </div>
  </div>
  <div class="stat-card active">
    <div class="icon-wrapper"> <i class="fas fa-user-check"></i> </div>
    <div class="stat-info"> <span>Active Users</span>
      <h3 id="active-count"><%= totalCustomersCound - blockedCustomerCount %></h3>
    </div>
  </div>
  <div class="stat-card blocked">
    <div class="icon-wrapper"> <i class="fas fa-user-lock"></i> </div>
    <div class="stat-info"> <span>Blocked Users</span>
      <h3 id="block-count"><%= blockedCustomerCount %></h3>
    </div>
  </div>
</div>

<div class="filter-bar">
  <div class="search-wrapper">
    <i class="fas fa-search"></i>

    <input type="text" id="search-input" placeholder="Search customer name or email..." value="<%= searchQuery || '' %>" onkeyup="handleSearch()" />

    <% if (searchQuery) { %>
    <button class="clear-search-btn" onclick="clearSearch()">
      Clear
    </button>
    <% } %>
  </div>


  <div class="filter-group">
    <label for="status-filter">Status:</label>
    <select id="status-filter" class="filter-select" onchange="applyFilters()">
      <option value="all" <%= statusFilter === 'all' || !statusFilter ? 'selected' : '' %>>All</option>
      <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
      <option value="blocked" <%= statusFilter === 'blocked' ? 'selected' : '' %>>Blocked</option>
    </select>
  </div>

  <div class="filter-group">
    <label for="sort-by">Sort By:</label>
    <select id="sort-by" class="filter-select" onchange="applyFilters()">
      <option value="recent" <%= sortBy === 'recent' || !sortBy ? 'selected' : '' %>>Recent</option>
      <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>Oldest</option>
    </select>
  </div>

  <% const hasActiveFilters = (statusFilter && statusFilter !== 'all') || (sortBy && sortBy !== 'recent'); %>
  <% if (hasActiveFilters) { %>
  <button class="btn-clear-filters" onclick="clearAllFilters()">
    <i class="fas fa-times-circle"></i>
    Clear Filters
  </button>
  <% } %>
</div>

<!-- Active Filters Display -->
<% if (searchQuery || hasActiveFilters) { %>
<div class="active-filters-bar">
  <span class="filter-label">Active Filters:</span>
  <div class="filter-tags">
    <% if (searchQuery) { %>
    <span class="filter-tag">
      Search: "<%= searchQuery %>"
      <button onclick="clearSearch()" class="tag-remove">
        <i class="fas fa-times"></i>
      </button>
    </span>
    <% } %>
    <% if (statusFilter && statusFilter !== 'all') { %>
    <span class="filter-tag">
      Status: <%= statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1) %>
      <button onclick="removeFilter('status')" class="tag-remove">
        <i class="fas fa-times"></i>
      </button>
    </span>
    <% } %>
    <% if (sortBy && sortBy !== 'recent') { %>
    <span class="filter-tag">
      Sort: <%= sortBy.charAt(0).toUpperCase() + sortBy.slice(1) %>
      <button onclick="removeFilter('sort')" class="tag-remove">
        <i class="fas fa-times"></i>
      </button>
    </span>
    <% } %>
  </div>
  <button class="clear-all-link" onclick="clearAllFiltersAndSearch()">Clear All</button>
</div>
<% } %>

<div class="table-container">
  <table class="customers-table">
    <thead>
      <tr>
        <th>Image</th>
        <th>Customer Name</th>
        <th>Orders</th>
        <th>Balance</th>
        <th>Status</th>
        <th>Block/Unblock</th>
      </tr>
    </thead>
    <tbody>
      <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
      <% customers.forEach(customer => { %>
      <tr>
        <td> <img src="<%= customer.avatar %>" alt="<%= customer.username %>" onerror="this.onerror=null; this.src='/images/user-avatar.svg';" class="customer-avatar" /> </td>
        <td>
          <div class="customer-info">
            <span><%= customer.username %></span>
            <small><%= customer.email %></small>
          </div>
        </td>
        <td><%= customer.orderCount %></td>
        <td>â‚¹<%= customer.balance %></td>
        <td>
          <% if (customer.isBlocked) { %>
          <span class="status-badge status-blocked" data-customer-id="<%= customer._id %>" data-customer-status>
            <i class="fas fa-circle"></i> Blocked
          </span>
          <% } else { %>
          <span class="status-badge status-active" data-customer-id="<%= customer._id %>" data-customer-status>
            <i class="fas fa-circle"></i> Active
          </span>
          <% } %>
        </td>
        <td>
          <% if (customer.isBlocked) { %>
          <button class="action-btn unblock-btn" data-is-blocked="<%= customer.isBlocked %>" data-customer-id="<%= customer._id %>">
            Unblock
          </button>
          <% } else { %>
          <button class="action-btn block-btn" data-is-blocked="<%= customer.isBlocked %>" data-customer-id="<%= customer._id %>">
            Block
          </button>
          <% } %>
        </td>
      </tr>
      <% }); %>
      <% } else { %>
      <tr>
        <td colspan="6" class="no-data">
          <div class="empty-state">
            <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
            <p style="font-size: 16px; color: #6c757d; margin: 0;">No customers found</p>
            <% if (searchQuery || hasActiveFilters) { %>
            <button class="btn-primary" onclick="clearAllFiltersAndSearch()" style="margin-top: 16px; padding: 10px 20px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer;">
              Clear All Filters
            </button>
            <% } %>
          </div>
        </td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<%- include('../partials/admin/customers/pagination') %>