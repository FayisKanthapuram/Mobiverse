<!-- Coupons Management Page -->
<div class="max-w-7xl mx-auto">
  <!-- Page Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-bold m-0 text-gray-900">Coupons Management</h1>
      <p class="text-gray-500 text-sm mt-1 m-0">Create and manage discount coupons for your customers.</p>
    </div>
    <div class="flex gap-3 flex-wrap">
      <button class="flex items-center gap-2 px-6 py-3 bg-gray-600 text-white border-none rounded-lg font-semibold text-sm cursor-pointer transition-all hover:bg-gray-700 hover:-translate-y-0.5 hover:shadow-lg" 
              onclick="exportCoupons()">
        <i class="bi bi-download"></i>
        Export
      </button>
      <button class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white border-none rounded-lg font-semibold text-sm cursor-pointer transition-all hover:bg-blue-700 hover:-translate-y-0.5 hover:shadow-lg" 
              onclick="openAddCouponModal()">
        <i class="bi bi-plus-circle"></i>
        Add New Coupon
      </button>
    </div>
  </div>

  <!-- Analytics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="stat-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5 transition-all hover:-translate-y-0.5 hover:shadow-lg border-l-4 border-l-blue-600">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl flex-shrink-0 bg-blue-50 text-blue-600">
        <i class="bi bi-ticket-perforated"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm text-gray-500 mb-1">Total Coupons</div>
        <div class="text-3xl font-bold text-gray-900 leading-none"><%= analytics.totalCoupons || 0 %></div>
      </div>
    </div>

    <div class="stat-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5 transition-all hover:-translate-y-0.5 hover:shadow-lg border-l-4 border-l-green-600">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl flex-shrink-0 bg-green-50 text-green-600">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm text-gray-500 mb-1">Active Coupons</div>
        <div class="text-3xl font-bold text-gray-900 leading-none"><%= analytics.activeCoupons || 0 %></div>
      </div>
    </div>

    <div class="stat-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5 transition-all hover:-translate-y-0.5 hover:shadow-lg border-l-4 border-l-red-600">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl flex-shrink-0 bg-red-50 text-red-600">
        <i class="bi bi-clock-history"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm text-gray-500 mb-1">Expired Coupons</div>
        <div class="text-3xl font-bold text-gray-900 leading-none"><%= analytics.expiredCoupons || 0 %></div>
      </div>
    </div>

    <div class="stat-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5 transition-all hover:-translate-y-0.5 hover:shadow-lg border-l-4 border-l-purple-600">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl flex-shrink-0 bg-purple-50 text-purple-600">
        <i class="bi bi-graph-up"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm text-gray-500 mb-1">Total Usage</div>
        <div class="text-3xl font-bold text-gray-900 leading-none"><%= analytics.totalUsage || 0 %></div>
      </div>
    </div>

    <div class="stat-card bg-white p-6 rounded-xl border border-gray-200 flex items-center gap-5 transition-all hover:-translate-y-0.5 hover:shadow-lg border-l-4 border-l-orange-600">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl flex-shrink-0 bg-orange-50 text-orange-600">
        <i class="bi bi-currency-rupee"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm text-gray-500 mb-1">Total Discount</div>
        <div class="text-lg font-bold text-gray-900 leading-none">₹<%= (analytics.totalDiscountGiven || 0).toLocaleString('en-IN') %></div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white p-5 rounded-xl border border-gray-200 mb-6 flex flex-col md:flex-row gap-4 items-stretch md:items-center">
    <div class="flex-1 min-w-[250px] relative flex items-center">
      <i class="bi bi-search absolute left-4 text-gray-500 pointer-events-none"></i>
      <input type="text"
             id="searchInput"
             placeholder="Search by code or name..."
             value="<%= searchQuery || '' %>"
             onkeyup="handleSearch()"
             class="w-full py-2.5 pl-11 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      <% if (searchQuery) { %>
      <button class="clear-search-btn absolute right-2 bg-transparent border-none text-gray-500 cursor-pointer p-1 flex items-center hover:text-red-600 transition-colors" 
              onclick="clearSearch()" 
              title="Clear search">
        <i class="bi bi-x-circle-fill"></i>
      </button>
      <% } %>
    </div>

    <div class="flex items-center gap-2">
      <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Type:</label>
      <select id="typeFilter" 
              class="px-3 py-2.5 pr-8 pl-3 border border-gray-300 rounded-lg text-sm bg-white cursor-pointer min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              onchange="applyFilters()">
        <option value="">All</option>
        <option value="percentage" <%= typeFilter === 'percentage' ? 'selected' : '' %>>Percentage</option>
        <option value="fixed" <%= typeFilter === 'fixed' ? 'selected' : '' %>>Fixed Amount</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Status:</label>
      <select id="statusFilter" 
              class="px-3 py-2.5 pr-8 pl-3 border border-gray-300 rounded-lg text-sm bg-white cursor-pointer min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              onchange="applyFilters()">
        <option value="">All</option>
        <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Active</option>
        <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Inactive</option>
        <option value="expired" <%= statusFilter === 'expired' ? 'selected' : '' %>>Expired</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Sort:</label>
      <select id="sortFilter" 
              class="px-3 py-2.5 pr-8 pl-3 border border-gray-300 rounded-lg text-sm bg-white cursor-pointer min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
              onchange="applyFilters()">
        <option value="recent" <%= sortFilter === 'recent' ? 'selected' : '' %>>Recent</option>
        <option value="oldest" <%= sortFilter === 'oldest' ? 'selected' : '' %>>Oldest</option>
        <option value="usage-high" <%= sortFilter === 'usage-high' ? 'selected' : '' %>>Most Used</option>
        <option value="usage-low" <%= sortFilter === 'usage-low' ? 'selected' : '' %>>Least Used</option>
      </select>
    </div>
  </div>

  <!-- Coupons Table -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-50 border-b-2 border-gray-200">
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Coupon Code</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Name</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Type</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Discount</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Min Purchase</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Usage</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Valid Until</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Status</th>
            <th class="px-4 py-4 text-left font-semibold text-xs text-gray-700 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (coupons && coupons.length > 0) { %>
            <% coupons.forEach(coupon => { %>
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                <td class="px-4 py-4 align-middle">
                  <div class="flex items-center gap-2">
                    <strong class="font-mono text-sm text-blue-600 font-bold tracking-wide"><%= coupon.code %></strong>
                    <button class="text-gray-500 hover:text-blue-600 transition-colors" 
                            onclick="copyCouponCode('<%= coupon.code %>')" 
                            title="Copy code">
                      <i class="bi bi-clipboard text-sm"></i>
                    </button>
                  </div>
                </td>
                <td class="px-4 py-4 align-middle">
                  <div class="flex items-center gap-2 max-w-[150px]">
                    <strong class="text-gray-900 truncate"><%= coupon.name %></strong>
                    <% if (coupon.description) { %>
                      <i class="bi bi-info-circle text-gray-500 text-xs cursor-help flex-shrink-0" title="<%= coupon.description %>"></i>
                    <% } %>
                  </div>
                </td>
                <td class="px-4 py-4 align-middle">
                  <% 
                    let typeClass = '';
                    let typeText = '';
                    if (coupon.type === 'percentage') {
                      typeClass = 'bg-green-100 text-green-800';
                      typeText = 'Percentage';
                    } else {
                      typeClass = 'bg-blue-100 text-blue-800';
                      typeText = 'Fixed';
                    }
                  %>
                  <span class="inline-block px-3 py-1.5 rounded-md text-xs font-semibold uppercase tracking-wide <%= typeClass %>">
                    <%= typeText %>
                  </span>
                </td>
                <td class="px-4 py-4 align-middle">
                  <% if (coupon.type === 'percentage') { %>
                    <strong class="text-gray-900"><%= coupon.discountValue %>%</strong>
                    <% if (coupon.maxDiscount) { %>
                      <div class="text-xs text-gray-500 mt-0.5">Max: ₹<%= coupon.maxDiscount %></div>
                    <% } %>
                  <% } else { %>
                    <strong class="text-gray-900">₹<%= coupon.discountValue %></strong>
                  <% } %>
                </td>
                <td class="px-4 py-4 align-middle text-sm text-gray-700">₹<%= coupon.minPurchaseAmount.toLocaleString('en-IN') %></td>
                <td class="px-4 py-4 align-middle">
                  <div class="min-w-[100px]">
                    <strong class="text-gray-900"><%= coupon.currentUsageCount || 0 %></strong>
                    <% if (coupon.totalUsageLimit > 0) { %>
                      <span class="text-gray-500"> / <%= coupon.totalUsageLimit %></span>
                      <div class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-green-600 to-teal-500 transition-all" style="width: <%= Math.min((coupon.currentUsageCount / coupon.totalUsageLimit) * 100, 100) %>%"></div>
                      </div>
                    <% } else { %>
                      <span class="text-xs text-gray-500"> / Unlimited</span>
                    <% } %>
                  </div>
                </td>
                <td class="px-4 py-4 align-middle text-sm text-gray-700"><%= new Date(coupon.endDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                <td class="px-4 py-4 align-middle">
                  <% 
                    let statusClass = '';
                    let statusText = '';
                    const now = new Date();
                    const end = new Date(coupon.endDate);
                    
                    if (!coupon.isActive) {
                      statusClass = 'bg-red-100 text-red-800';
                      statusText = 'Inactive';
                    } else if (now > end) {
                      statusClass = 'bg-red-100 text-red-800';
                      statusText = 'Expired';
                    } else if (coupon.totalUsageLimit > 0 && coupon.currentUsageCount >= coupon.totalUsageLimit) {
                      statusClass = 'bg-red-100 text-red-800';
                      statusText = 'Used Up';
                    } else {
                      statusClass = 'bg-green-100 text-green-800';
                      statusText = 'Active';
                    }
                  %>
                  <span class="inline-block px-3 py-1.5 rounded-md text-xs font-semibold uppercase tracking-wide <%= statusClass %>">
                    <%= statusText %>
                  </span>
                </td>
                <td class="px-4 py-4 align-middle">
                  <div class="flex gap-2">
                    <button class="w-9 h-9 flex items-center justify-center border-none rounded-md cursor-pointer transition-all text-base bg-purple-50 text-purple-600 hover:bg-purple-600 hover:text-white" 
                            onclick="viewCouponDetails('<%= coupon._id %>')" 
                            title="View Details">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="w-9 h-9 flex items-center justify-center border-none rounded-md cursor-pointer transition-all text-base bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white" 
                            onclick="editCoupon('<%= coupon._id %>')" 
                            title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="w-9 h-9 flex items-center justify-center border-none rounded-md cursor-pointer transition-all text-base <%= coupon.isActive ? 'bg-yellow-50 text-yellow-600 hover:bg-yellow-400 hover:text-white' : 'bg-green-50 text-green-600 hover:bg-green-600 hover:text-white' %>" 
                            onclick="toggleCouponStatus('<%= coupon._id %>', <%= coupon.isActive %>)" 
                            title="<%= coupon.isActive ? 'Deactivate' : 'Activate' %>">
                      <i class="bi <%= coupon.isActive ? 'bi-x-circle' : 'bi-check-circle' %>"></i>
                    </button>
                    <button class="w-9 h-9 flex items-center justify-center border-none rounded-md cursor-pointer transition-all text-base bg-red-50 text-red-600 hover:bg-red-600 hover:text-white" 
                            onclick="deleteCoupon('<%= coupon._id %>')" 
                            title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="9" class="p-12 text-center">
                <div class="flex flex-col items-center gap-4">
                  <i class="bi bi-ticket-perforated text-6xl text-gray-300"></i>
                  <p class="text-gray-500 text-lg m-0">No coupons found</p>
                  <button class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white border-none rounded-lg font-semibold text-sm cursor-pointer transition-all hover:bg-blue-700" 
                          onclick="openAddCouponModal()">
                    <i class="bi bi-plus-circle"></i>
                    Create Your First Coupon
                  </button>
                </div>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="flex flex-col md:flex-row justify-between items-center gap-4">
    <div class="text-gray-500 text-sm">
      <% if (coupons && coupons.length > 0) { %>
        <% const startItem = (currentPage - 1) * limit + 1; %>
        <% const endItem = Math.min((currentPage - 1) * limit + coupons.length, totalCoupons); %>
        Showing <%= startItem %> to <%= endItem %> of <%= totalCoupons %> results
      <% } else { %>
        No results found
      <% } %>
    </div>

    <div class="flex gap-2 items-center">
      <% if(currentPage > 1) { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md cursor-pointer font-medium transition-all hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50" 
                onclick="changePage(<%= currentPage - 1 %>)">
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } else { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md opacity-40 cursor-not-allowed" 
                disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
      <% } %>
      
      <% 
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        if (endPage - startPage < maxPagesToShow - 1) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
      %>
      
      <% if (startPage > 1) { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md cursor-pointer font-medium transition-all hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50" 
                onclick="changePage(1)">1</button>
        <% if (startPage > 2) { %>
          <span class="px-1 text-gray-500">...</span>
        <% } %>
      <% } %>
      
      <% for(let i = startPage; i <= endPage; i++) { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border rounded-md cursor-pointer font-medium transition-all <%= currentPage === i ? 'bg-blue-600 text-white border-blue-600 font-semibold' : 'border-gray-300 bg-white text-gray-700 hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50' %>" 
                onclick="changePage(<%= i %>)">
          <%= i %>
        </button>
      <% } %>
      
      <% if (endPage < totalPages) { %>
        <% if (endPage < totalPages - 1) { %>
          <span class="px-1 text-gray-500">...</span>
        <% } %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md cursor-pointer font-medium transition-all hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50" 
                onclick="changePage(<%= totalPages %>)"><%= totalPages %></button>
      <% } %>
      
      <% if(currentPage < totalPages) { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md cursor-pointer font-medium transition-all hover:border-blue-600 hover:text-blue-600 hover:bg-blue-50" 
                onclick="changePage(<%= currentPage + 1 %>)">
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } else { %>
        <button class="min-w-[36px] h-9 flex items-center justify-center px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md opacity-40 cursor-not-allowed" 
                disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
      <% } %>
    </div>
  </div>
</div>

<%- include('../partials/admin/coupons/couponModal') %>
<%- include('../partials/admin/coupons/viewModal') %>